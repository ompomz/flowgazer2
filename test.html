<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweetviewer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; line-height: 1.5; background-color: #f7f7f7; color: #666; font-size: 0.9rem; padding: 0.5rem; }
.container { max-width: 600px; margin: 0; padding: 0.5rem; border-radius: 4px; }
.container h1 { font-size: 1.3rem; }
.container h2 { font-size: 1.1rem; }
.container p { word-break: break-all; }
.container a { color: #66b3ff; text-decoration: none; }
.container a:hover { color: #4da6ff; text-decoration: underline; }
@media (max-width: 767px) { .container { max-width: 100%; } }
.container button { border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: background-color 0.3s ease, color 0.3s ease; }
.container button:hover { background-color: #ffa347; }
.header-section { display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px dashed #ddd; }
#main-event { padding: 0.5rem 0; }
#status { margin: 0.5rem 0rem; font-weight: bold; color: #ff99cc; }
.reactions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.25rem 0rem 0.75rem 0rem; }
.reactions-list img{ height: 1.25rem !important; object-fit: cover;}
.reaction-group { display: flex; align-items: center; background-color: #eee; border-radius: 999px; padding: 0.2rem 0.5rem; font-size: 0.8rem; }
.reaction-avatars { display: flex; flex-direction: row-reverse; }
.reaction-avatar { width: 1.25rem; height: 1.25rem; border-radius: 50%; object-fit: cover; display: block; margin: 0; }
.related-posts { margin: 0.5rem 0rem; }
.related-post-card { background-color: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem 0.5rem; margin: 0.5rem 0rem; }
.related-post-card .profile { display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0rem; }
.related-post-card .profile-name, .related-post-card .profile-npub { font-size: 0.8rem; }
.related-post-card .profile-image { width: 1.5rem; height: 1.5rem; }
.related-post-card .post-content { font-size: 0.8rem; margin: 0.5rem 0rem 0.75rem 0rem; }
.profile { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.profile-image { width: 2rem; height: 2rem; border-radius: 50%; object-fit: cover; }
.profile-name { font-weight: bold; font-size: 1rem; color: #444; }
.profile-nip05, .profile-npub { text-decoration: none !important; font-size: 0.8rem; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.profile-picture { width: 6rem; height: 6rem; border-radius: 50%; object-fit: cover; border: 3px solid rgba(0, 121, 107, 0.5); }
@media (max-width: 370px) { .profile-picture { width: 4.5rem; height: 4.5rem; } }
.profile-card { display: flex; flex-direction: column; gap: 1rem; padding: 1rem; background-color: #fff; border-radius: 8px; border: 1px solid #ddd; }
.profile-header { display: flex; align-items: center; gap: 1rem; }
.profile-info-container { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
.npub-container { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; word-break: break-all; padding: 0.25rem 0rem 0rem 0rem; }
.copy-icon { cursor: pointer; transition: opacity 0.2s ease; }
.copy-icon:hover { opacity: 0.4; }
.about-text { font-size: 0.9rem; line-height: 1.5; color: #333; word-break: break-all; }
.about-text a { color: #66b3ff; text-decoration: underline; }
.about-text a:hover { color: #4da6ff; }
.about-text .custom-emoji { height: 1.2rem; vertical-align: middle; }
.post-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #999; }
.post-content { margin: 0.5rem 0rem; line-height: 1.5; overflow-wrap: break-word; word-break: break-word; }
.post-content img { max-width: 15rem; max-height: 15rem; height: auto; display: block; margin: 0; }
.post-content img.custom-emoji { vertical-align: middle; display: inline-block; height: 1.2rem; }
.post-content ul, .post-content ol { list-style-position: inside; }
.nostr-form { display: flex; flex-direction: row; align-items: center; gap: 0.5rem; padding-top: 0.25rem; }
.form-input { flex: 1; min-width: 0; width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
.form-button { flex-shrink: 0; padding: 0.5rem 1.2rem !important; }
.footer-section { padding: 0.5rem 0; border-top: 1px dashed #ddd; }
.hidden { display: none; }
.modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.modal-content { margin: auto; display: block; max-width: 80%; max-height: 80vh; width: 80%; }
.modal-image { width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
.close-button { color: #fff; font-size: 40px; font-weight: 700; cursor: pointer; transition: 0.3s; }
.close-button:hover, .close-button:focus { color: #eee; text-decoration: none; cursor: pointer; }
.custom-emoji-hover:hover { transform: scale(2.0); z-index: 10; }
</style>
</head>
<body>
<div id="modal-placeholder"></div>

<div class="container">
    <div id="nav-section" class="header-section">
        <button id="btn-back">„ÇÇ„Å©„Çã</button>
        <button id="btn-share">„Ç∑„Çß„Ç¢</button>
        <button id="btn-auth" class="auth-button">Èçµ„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ„ÅØ„Åì„Å°„Çâ</button>
    </div>

    <main id="main-content">
        <div id="loading-status" class="hidden"></div>
        <div id="render-area"></div>
    </main>

    <section id="sub-content" class="hidden">
        <div id="reactions-section">
            <h3>„É™„Ç¢„ÇØ„Ç∑„Éß„É≥</h3>
            <div id="reactions-list"></div>
        </div>
        <div id="related-events-section">
            <h3>Èñ¢ÈÄ£„Ç§„Éô„É≥„Éà</h3>
            <div id="related-events-list"></div>
        </div>
    </section>

    <div id="footer-section" class="footer-section">
        <button id="btn-back-footer">„ÇÇ„Å©„Çã</button>
        <button id="save-list-btn" style="display:none;">„Éï„Ç©„É≠„Éº„É™„Çπ„Éà„Çí‰øùÂ≠ò</button>
    </div>
</div>

<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth-ui.js"></script>
<script src="https://ompomz.github.io/flowgazer/relay-manager.js"></script>
<script src="https://ompomz.github.io/flowgazer/data-store.js"></script>
<script src="https://ompomz.github.io/flowgazer/profile-fetcher.js"></script>

<script>

    const FALLBACK_RELAYS = [
        "wss://relay.damus.io/",
        "wss://nos.lol/",
        "wss://relay.nostr.band/"
    ];

    function setupFormListener() {
        const form = document.getElementById('nostr-form');
        if (!form) return;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('nostr-id-input').value.trim();
            if (input) {
                window.location.href = `?id=${input}`;
            }
        });
    }

    function showStatus(message) {
        const statusElement = document.getElementById('loading-status'); // HTMLÂÅ¥„ÅÆID„Å´Âêà„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ
        if (!statusElement) return;

        statusElement.textContent = message;
        if (message) {
            statusElement.classList.remove('hidden');
        } else {
            statusElement.classList.add('hidden');
        }
    }

    // --- 1. IDÂà§Âà•„Å®„É´„Éº„ÉàÊåØ„ÇäÂàÜ„Åë ---
    function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const renderArea = document.getElementById('render-area');

        // 1. ID„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éï„Ç©„Éº„É†„ÇíË°®Á§∫
        if (!id) {
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // 2. ID„ÅÆÁ®ÆÈ°û„ÇíÂà§ÂÆö„Åó„Å¶ÊåØ„ÇäÂàÜ„Åë
        try {
            const decoded = NostrTools.nip19.decode(id);

            switch (decoded.type) {
                case 'npub':
                case 'nprofile':
                    // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„É¢„Éº„Éâ„Å∏
                    startProfileWorkflow(decoded);
                    break;

                case 'note':
                case 'nevent':
                case 'naddr':
                    // ÊäïÁ®øË©≥Á¥∞Ë°®Á§∫„É¢„Éº„Éâ„Å∏
                    startEventWorkflow(decoded);
                    break;

                default:
                    showStatus('„Ç®„É©„Éº: Êú™ÂØæÂøú„ÅÆIDÂΩ¢Âºè„Åß„Åô„ÄÇ');
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
            }
        } catch (err) {
            showStatus('„Ç®„É©„Éº: ID„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
        }
    }

    // --- 2. „É¨„É≥„ÉÄ„É™„É≥„Ç∞„Éª„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (HTML„ÇíÁµÑ„ÅøÁ´ã„Å¶„ÇãÂ∞ÇÈñÄÂÆ∂) ---
    const Components = {
        // „Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„Éâ„ÅÆÁîüÊàê
        profileCard: (profile, npub) => {
            const picture = profile.picture || './favicon.ico';
            const name = profile.name || 'Unknown';
            const about = profile.about ? `<p class="about-text">${Components.utils.escape(profile.about).replace(/\n/g, '<br>')}</p>` : '';

            return `
            <div class="profile-card">
                <div class="profile-header">
                    <img src="${picture}" class="profile-picture">
                    <div class="profile-info">
                        <h2 class="profile-name">${name}</h2>
                        <code class="npub-text">${npub.substring(0, 12)}...</code>
                    </div>
                </div>
                ${about}
            </div>
        `;
        },

        // ÊäïÁ®øÔºà„Ç§„Éô„É≥„ÉàÔºâÊú¨‰Ωì„ÅÆÁîüÊàê
        eventBody: (event, contentHtml, profile = {}) => {
            const date = new Date(event.created_at * 1000).toLocaleString();
            const picture = profile.picture || './favicon.ico';
            const name = profile.display_name || profile.name || 'Unknown';

            return `
        <div class="main-post">
            <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="${picture}" style="width: 48px; height: 48px; border-radius: 50%;">
                <div>
                    <div style="font-weight: bold;">${Components.utils.escape(name)}</div>
                    <div style="font-size: 0.8rem; color: #666;">@${NostrTools.nip19.npubEncode(event.pubkey).substring(0, 10)}...</div>
                </div>
            </div>
            <div class="post-content">${contentHtml}</div>
            <div class="post-footer" style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                <span>${date}</span>
            </div>
        </div>
        `;
        },

        // ÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅÆÁîüÊàê
        inputForm: () => `
        <div class="input-form-container">
            <p class="form-title">Nostr ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <form id="nostr-form" class="nostr-form">
                <input type="text" id="nostr-id-input" placeholder="nevent1..., npub1..." required class="form-input">
                <button type="submit" class="form-button">Ë°®Á§∫</button>
            </form>
        </div>
        `,

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Ôºà„ÉÜ„Ç≠„Çπ„ÉàÊàêÂΩ¢„Å™„Å©Ôºâ
        utils: {
            escape: (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])),

            // ÊäïÁ®øÊú¨Êñá„Çí„É™„ÉÉ„ÉÅ„Å´„Åô„ÇãÔºàÁîªÂÉèÂ±ïÈñã„Éª„É™„É≥„ÇØÂåñÔºâ
            formatContent: async (content, tags) => {
                // 1. „Ç®„Çπ„Ç±„Éº„Éó„Å®ÊîπË°åÂá¶ÁêÜ
                let html = Components.utils.escape(content).replace(/\n/g, '<br>');

                // 2. URL„ÅÆÂá¶ÁêÜÔºàÁîªÂÉèÂ±ïÈñã or Â§ñÈÉ®„É™„É≥„ÇØÔºâ
                const urlRegex = /\b(https?:\/\/[^\s]+)/g;
                html = html.replace(urlRegex, (url) => {
                    if (/\.(png|jpe?g|gif|webp|svg)$/i.test(url)) {
                        return `<img src="${url}" class="post-image" onclick="openModal('${url}')" style="max-width:100%; border-radius:8px; margin: 10px 0; cursor:pointer;">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
                });

                // 3. Nostr ID (nostr:...) „ÅÆÂá¶ÁêÜ
                const nostrRegex = /nostr:(n(?:pub|event|ote|profile|addr)1[a-z0-9]+)/g;
                html = html.replace(nostrRegex, (match, nip19Id) => {
                    return `
                    <div class="quote-placeholder" data-id="${nip19Id}">
                    <a href="?id=${nip19Id}" class="nostr-link">nostr:${nip19Id.substring(0, 12)}...</a>
                    </div>`;
                });

                // 4. „Ç´„Çπ„Çø„É†ÁµµÊñáÂ≠ó„ÅÆÁΩÆÊèõ
                tags.filter(t => t[0] === 'emoji').forEach(([_, code, url]) => {
                    const reg = new RegExp(`:${code}:`, 'g');
                    html = html.replace(reg, `<img src="${url}" class="custom-emoji" title=":${code}:" style="height: 1.2em; vertical-align: middle;">`);
                });

                return html;
            }            
        },

        reactionSection: (reactions) => {
            if (reactions.length === 0) return '';
            return `<div class="reactions-summary">üåü ${reactions.length} reactions</div>`;
        },

        replyCard: (event, contentHtml) => {
            return `
            <div class="reply-card">
                <div class="reply-content">${contentHtml}</div>
            </div>
        `;
        },
        
        quoteCard: (eventId, contentHtml = "Ë™≠„ÅøËæº„Åø‰∏≠...", profile = {}) => {
            const name = profile.display_name || profile.name || '...';
            return `
        <div id="quote-${eventId}" class="quote-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.9rem; background: #fafafa;">
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                <img src="${profile.picture || ''}" style="width: 20px; height: 20px; border-radius: 50%; background: #eee;">
                <span style="font-weight: bold;">${Components.utils.escape(name)}</span>
            </div>
            <div class="quote-content">${contentHtml}</div>
        </div>
        `;
        }
    };

    // --- 3. „É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÁÆ°ÁêÜ ---
    function setupEventListeners() {
        // „ÇÇ„Å©„Çã„Éú„Çø„É≥
        const backBtns = [document.getElementById('btn-back'), document.getElementById('btn-back-footer')];
        backBtns.forEach(btn => {
            btn?.addEventListener('click', () => {
                window.history.length > 1 ? window.history.back() : window.location.href = './';
            });
        });

        // „Ç∑„Çß„Ç¢„Éú„Çø„É≥
        document.getElementById('btn-share')?.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => alert('URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
        });

        // Ë™çË®º„Éú„Çø„É≥ (Â§ñÈÉ®„ÅÆ auth-ui.js „ÇíÂëº„Å≥Âá∫„ÅôÊÉ≥ÂÆö)
        document.getElementById('btn-auth')?.addEventListener('click', () => {
            if (typeof showAuthUI === 'function') showAuthUI();
        });
    }

    // --- 4. Workflow („Éá„Éº„Çø„ÅÆÂèñÂæó„Åã„ÇâË°®Á§∫„Åæ„Åß„ÅÆÊâãÈ†Ü) ---

    // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„ÅÆÊµÅ„Çå
        async function startProfileWorkflow(decoded) {
            showStatus('„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...');

            // npub„Åæ„Åü„ÅØnprofile„Åã„ÇâÂÖ¨ÈñãÈçµ„ÇíÂèñÂæó
            const pubkey = decoded.data.pubkey || decoded.data.id || decoded.data;

            // „É™„É¨„Éº„É™„Çπ„Éà„ÅÆÊ±∫ÂÆöÔºàID„Å´Á¥ê„Å•„Åè„É™„É¨„Éº„Åå„ÅÇ„Çå„Å∞ÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞FallbackÔºâ
            const relays = (decoded.data.relays && decoded.data.relays.length > 0)
                ? decoded.data.relays
                : FALLBACK_RELAYS;

            try {
                // 1. „É™„É¨„Éº„Å´Êé•Á∂ö
                await relayManager.connect(relays[0]);

                // 2. Ë≥ºË™≠ÈñãÂßã (subId, filters, handler)
                // relay-manager.js „ÅÆ‰ªïÊßòÈÄö„Çä„ÄÅ3„Å§„ÅÆÂºïÊï∞„ÇíÊ∏°„Åó„Åæ„Åô
                relayManager.subscribe(
                    'profile-query',           // subId
                    {                          // filters
                        kinds: [0],
                        authors: [pubkey],
                        limit: 1
                    },
                    (type, event) => {         // handler („Ç≥„Éº„É´„Éê„ÉÉ„ÇØ)
                        if (type === 'EVENT' && event) {
                            try {
                                const profile = JSON.parse(event.content);
                                const npub = NostrTools.nip19.npubEncode(pubkey);

                                // 3. ÊèèÁîª
                                const renderArea = document.getElementById('render-area');
                                renderArea.innerHTML = Components.profileCard(profile, npub);

                                showStatus(''); // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊ∂à„Åô

                                // 4. Áî®„ÅåÊ∏à„Çì„Å†„ÇâË≥ºË™≠Ëß£Èô§
                                relayManager.unsubscribe('profile-query');
                            } catch (e) {
                                console.error("Profile parse error:", e);
                            }
                        }
                    }
                );

            } catch (err) {
                console.error("Connection error:", err);
                showStatus('„É™„É¨„Éº„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

    // --- 1. „Åæ„Åö„Ç§„Éô„É≥„Éà„Çí1„Å§„Å†„ÅëÂèñ„Å£„Å¶„Åè„ÇãÈñ¢Êï∞ ---
    async function fetchSingleEvent(decoded) {
        const eventId = decoded.data.id || decoded.data;
        const relays = (decoded.data.relays && decoded.data.relays.length > 0) ? decoded.data.relays : FALLBACK_RELAYS;

        return new Promise(async (resolve) => {
            await relayManager.connect(relays[0]);

            const subId = `fetch-once-${eventId.substring(0, 8)}`;

            // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà5ÁßíÂæÖ„Å£„Å¶„ÇÇÊù•„Å™„Åë„Çå„Å∞nullÔºâ
            const timer = setTimeout(() => {
                relayManager.unsubscribe(subId);
                resolve(null);
            }, 5000);

            relayManager.subscribe(subId, { ids: [eventId], limit: 1 }, (type, event) => {
                if (type === 'EVENT' && event) {
                    clearTimeout(timer);
                    relayManager.unsubscribe(subId);
                    resolve(event);
                }
            });
        });
    }

    // --- 2. ÊåØ„ÇäÂàÜ„Åë„ÇíË°å„ÅÜ„É°„Ç§„É≥„ÉØ„Éº„ÇØ„Éï„É≠„Éº ---
    async function startEventWorkflow(decoded) {
        showStatus('„Ç§„Éô„É≥„Éà„Çí„É≠„Éº„Éâ‰∏≠...');

        const event = await fetchSingleEvent(decoded);

        if (!event) {
            showStatus('„Ç§„Éô„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            const renderArea = document.getElementById('render-area');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // „Åì„Åì„Åß Kind „Åî„Å®„ÅÆÂá¶ÁêÜ„Å´ÂàÜÂ≤êÔºÅ
        console.log(`üì° Event Kind: ${event.kind} „ÇíÊ§úÁü•„Åó„Åæ„Åó„Åü`);

        switch (event.kind) {
            case 1:
            case 30023:
                // ÈÄöÂ∏∏ÊäïÁ®ø„ÄÅ„Åæ„Åü„ÅØ„É≠„É≥„Ç∞„Éï„Ç©„Éº„É†
                await renderStandardPost(event);
                break;

            case 40:
            case 41:
                // „ÉÅ„É£„É≥„Éç„É´ÊÉÖÂ†±„Åù„ÅÆ„ÇÇ„ÅÆ
                renderChannelMetadata(event);
                break;

            case 42:
                // „ÉÅ„É£„É≥„Éç„É´„É°„ÉÉ„Çª„Éº„Ç∏ÔºàNIP-28Ôºâ
                await renderChannelMessage(event);
                break;

            case 6:
                // „É™„Éù„Çπ„ÉàÔºàÂÖÉ„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÂèñÂæó„Åó„Å´Ë°å„Åè„Å™„Å©„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶ÅÔºâ
                renderGenericEvent(event, "„É™„Éù„Çπ„Éà„Åï„Çå„Åæ„Åó„Åü");
                break;

            default:
                // „Åù„ÅÆ‰ªñÔºàÊú™ÂÆöÁæ©„ÅÆKindÔºâ
                renderGenericEvent(event);
                break;
        }

        showStatus(''); // Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü
    }

    async function renderChannelMessage(event) {
        const renderArea = document.getElementById('render-area');
        const channelId = event.tags.find(t => t[0] === 'e' && (t[3] === 'root' || !t[3]))?.[1];

        // Êú¨Êñá„ÅÆÊï¥ÂΩ¢
        const contentHtml = await Components.utils.formatContent(event.content, event.tags);
        const profile = window.dataStore.getProfile(event.pubkey);

        renderArea.innerHTML = `
        <div class="channel-context" style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
            üí¨ „ÉÅ„É£„É≥„Éç„É´ÂÜÖ„ÅÆÁô∫Ë®Ä: <a href="?id=${channelId}">${channelId?.substring(0, 8)}...</a>
        </div>
        ${Components.eventBody(event, contentHtml, profile)}
    `;

        // Èñ¢ÈÄ£„Éá„Éº„Çø„ÅÆÂèñÂæóÔºà„É™„Éó„É©„Ç§„Å™„Å©Ôºâ
        fetchRelatedData(event.id);
    }

    // --- Èñ¢ÈÄ£„Éá„Éº„ÇøÔºà„É™„Éó„É©„Ç§„Éª„É™„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºâ„ÅÆÂèñÂæó ---
    async function fetchRelatedData(eventId, relays) {
        const reactionsList = document.getElementById('reactions-list');
        const relatedList = document.getElementById('related-events-list');
        const subContent = document.getElementById('sub-content');

        // „É™„Éó„É©„Ç§(1)„Å®„É™„Ç¢„ÇØ„Ç∑„Éß„É≥(7)„ÇíË≥ºË™≠
        relayManager.subscribe('related-data', { '#e': [eventId], kinds: [1, 7] }, async (type, event) => {
            if (type === 'EVENT' && event) {
                window.dataStore.addEvent(event);
                subContent.classList.remove('hidden');

                if (event.kind === 7) {
                    // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÊõ¥Êñ∞ÔºàDataStore„ÅÆÈõÜË®àÊ©üËÉΩ„ÇíÂà©Áî®Ôºâ
                    const counts = window.dataStore.getReactionCount(eventId);
                    reactionsList.innerHTML = Components.reactionSection({ length: counts.reactions });
                } else if (event.kind === 1) {
                    // „É™„Éó„É©„Ç§„ÅÆËøΩÂä†
                    const html = await Components.utils.formatContent(event.content, event.tags);
                    relatedList.innerHTML += Components.replyCard(event, html);
                }
            }
        });
    }

    async function fetchQuotes() {
        const placeholders = document.querySelectorAll('.quote-placeholder');

        for (const el of placeholders) {
            const nip19Id = el.dataset.id;
            try {
                const decoded = NostrTools.nip19.decode(nip19Id);
                const targetId = decoded.data.id || decoded.data;
                const relays = (decoded.data.relays && decoded.data.relays.length > 0) ? decoded.data.relays : FALLBACK_RELAYS;

                // 1. „É™„É¨„Éº„Å´Êé•Á∂ö
                await relayManager.connect(relays[0]);

                // 2. ÂºïÁî®„Ç§„Éô„É≥„ÉàÊú¨‰Ωì„ÇíË≥ºË™≠
                relayManager.subscribe(`quote-${targetId}`, { ids: [targetId], limit: 1 }, async (type, event) => {
                    if (type === 'EVENT' && event) {
                        // „Ç§„Éô„É≥„ÉàÂÜÖÂÆπ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                        const contentHtml = await Components.utils.formatContent(event.content, event.tags);

                        // --- ËøΩÂä†ÔºöÂºïÁî®ÂÖÉ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇÇÂèñÂæó„Åô„Çã ---
                        relayManager.subscribe(`profile-${event.pubkey}`, { kinds: [0], authors: [event.pubkey], limit: 1 }, (pType, pEvent) => {
                            if (pType === 'EVENT' && pEvent) {
                                const profileData = JSON.parse(pEvent.content);
                                // „Éó„É≠„Éï„Ç£„Éº„É´‰ªò„Åç„Åß„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
                                el.innerHTML = Components.quoteCard(targetId, contentHtml, profileData);
                                relayManager.unsubscribe(`profile-${event.pubkey}`);
                            }
                        });

                        // „Åæ„Åö„ÅØ„Éó„É≠„Éï„Ç£„Éº„É´„Å™„Åó„ÅÆÁä∂ÊÖã„ÅßË°®Á§∫„Åó„Å¶„Åä„Åè
                        el.innerHTML = Components.quoteCard(targetId, contentHtml);
                        relayManager.unsubscribe(`quote-${targetId}`);
                    }
                });
            } catch (e) {
                console.error("ÂºïÁî®„ÅÆÂèñÂæó„Å´Â§±Êïó:", e);
            }
        }
    }

    // --- 5. ÂÆüË°åÔºà„Åì„Åì„Åå„Çπ„Çø„Éº„ÉàÂú∞ÁÇπÔºâ ---
    document.addEventListener('DOMContentLoaded', () => {
        // „Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Å™„Å©„ÇíÊúâÂäπ„Å´„Åô„Çã
        setupEventListeners();

        // URL„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÊèèÁîª„ÇíÈñãÂßã„Åô„Çã
        initializeApp();
    });
</script>

</body>
</html>
