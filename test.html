<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flowgazer</title>
<link rel="icon" type="image/x-icon" href="https://ompomz.github.io/flowgazer/favicon.ico">
<style>
* { margin: 0; padding: 0; box-sizing: border-box;}
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; padding: 0.5rem; line-height: 1.3; font-weight: normal; background-color: #f7f7f7; color: #666; font-size: 0.9rem;}
.container { max-width: 600px; margin-left: 0.5rem; margin-right: auto; padding: 0.5rem 0.5rem 0rem 0.5rem;}
h1 { font-size: 1.2rem; margin: 0rem 0rem 0.5rem 0rem;}
p { margin: 0;}
a { color: #666; text-decoration: none;}
input, textarea { font-size: 0.9rem; padding: 0.5rem 0.3rem; border: 1px solid #ddd; border-radius: 4px; color: #666; background-color: #fff; cursor: pointer; transition: background-color 0.3s, color 0.3s;}
input[type="checkbox"] { padding: 0; margin: 0; vertical-align: middle; appearance: checkbox; -webkit-appearance: checkbox;}
textarea { resize: vertical;}
.container button { font-size: 0.8rem; font-weight: bold; padding: 0.25rem 1rem; margin: 0.5rem 0rem; border: 0px solid #ddd; border-radius: 999px; color: #fff; background-color: #666; white-space: nowrap; cursor: pointer; transition: background-color 0.3s, color 0.3s;}
.full-width { width: 100%; display: block;}
.hidden { display: none;}
.flex-container { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0rem;}
.flex-container input, .flex-container textarea { flex-grow: 1; margin: 0;}
.flex-container button { margin: 0; min-width: 0;}
.flex-container-matome { display: flex; flex-direction: column; align-items: flex-start; gap: 0.25rem;}
#settings-toggle-area { display: flex; justify-content: center;}
ul { list-style-type: none; padding: 0; margin: 0.55rem 0rem 0rem 0rem;}
li.event { word-break: break-all; padding: 0.5rem; border-top: 1px dashed #ddd;}
.event-highlighted { border: 1px solid #ffcc66;}
.npub-link { color: #66b3ff; white-space: normal; word-break: break-word; min-width: 0; flex: 1;}
.nostr-ref, .pubkey-ref { color: #66b3ff;}
.custom-emoji { height: 1.2rem; vertical-align: bottom;}
#load-more { font-size: 0.8rem; font-weight: bold; padding: 0.25rem 1rem; margin: 0.1rem 0rem; border: 0px solid #ddd; border-radius: 999px; color: #fff; background-color: #666; white-space: nowrap; cursor: pointer; transition: background-color 0.3s, color 0.3s;}
#load-more.loading { font-size: 0; pointer-events: none;}
#load-more.loading::before { content: "èª­ã¿è¾¼ã¿ä¸­..."; font-size: 0.8rem;}
#generate-keypair { background-color: #ff99cc; color: #ffffff;}
#generate-keypair:hover { background-color: #ff66b2;}
#get-from-extension, #load-more { background-color: #66b3ff; color: #ffffff;}
#get-from-extension:hover, #load-more:hover { background-color: #4da6ff;}
#send-new-post { background-color: #ffcc66; color: #ffffff;}
#send-new-post:hover { background-color: #ffb833;}
#subscribe-relay, #apply-filter, #clear-filter { background-color: #ffd700; color: #ffffff;}
#subscribe-relay:hover, #apply-filter:hover, #clear-filter:hover { background-color: #ffc400;}
#show-settings, #hide-settings { background-color: #999999; color: #ffffff; font-size: 0.7rem; font-weight: normal; padding: 0.2rem 1rem; margin: 0;}
#show-settings:hover, #hide-settings:hover { background-color: #888888;}
#cancel-loading { margin: 0.1rem 0rem; cursor: pointer; background-color: #bbeeff; color: #666; font-size: 0.8rem; font-weight: normal; padding: 0.25rem 1rem; border: 0px solid #ddd; border-radius: 999px; white-space: nowrap; transition: background-color 0.3s, color 0.3s;}
.event-liked { border-right: 0.3rem solid #ffd700;}
@media (max-width: 767px) { .container { max-width: 100%; padding: 8px 8px 0px 8px; margin: 0;} }
@media (max-width: 400px) { .container button { font-size: 0.6rem !important;} }
@media (max-width: 767px) { .auto-stop-message div { width: 100% !important; margin: auto;} }
#tutorial-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 9999; background-color: rgba(247, 247, 247, 0.5); display: none; backdrop-filter: blur(5px); transition: all 0.5s ease-in-out;}
#tutorial-modal { background-color: rgba(255, 255, 255, 0.8); padding: 1.2rem 1.2rem 0.5rem 1.2rem; border-radius: 0.6rem; max-width: 600px; width: 80%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); transition: all 0.5s ease-in-out; position: relative; }
#image-container { text-align: center; margin-bottom: 0.5rem;}
.tutorial-image { display: none; max-width: 100%; height: auto;}
.tutorial-image.active { display: block;}
#tutorial-navigation { display: flex; justify-content: space-between; margin: 0.5rem 0rem 0rem 0rem;}
#prev-button, #next-button { width: 2rem; height: 2rem; display: inline-flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: bold; color: rgba(224, 242, 241, 1); background-color: rgba(0, 121, 107, 0.7); border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;}
#prev-button:hover, #next-button:hover { background-color: rgba(0, 121, 107, 0.9);}
#tutorial-close-button { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.9rem; font-weight: bold; color: #e0f2f1; background-color: #00796b; padding: 0.25rem 0.5rem; border-radius: 999px; cursor: pointer; border: none; z-index: 10000; white-space: nowrap; transition: background-color 0.3s; }
#tutorial-close-button:hover { background-color: rgba(0, 121, 107, 0.7); }
.dot-navigation { text-align: center;}
.dot { height: 1rem; width: 1rem; background-color: #e0f2f1; border-radius: 50%; display: inline-block; margin: 0 5px; cursor: pointer; transition: background-color 0.3s ease; }
.dot.active { background-color: #00796b; }
.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.2);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);}
.modal-content{margin:auto;display:block;max-width:80%;max-height:80vh;width:80%;}
.modal-image{width:auto;height:auto;max-width:100%;max-height:100%;object-fit:contain;display:block;margin:auto;}
.close-button{color:#fff;font-size:40px;font-weight:700;cursor:pointer;transition:0.3s;}
.close-button:hover,.close-button:focus{color:#eee;text-decoration:none;cursor:pointer;}
</style>
</head>
<body>
<div id="header-placeholder"></div>
<div id="modal-placeholder"></div>
<div class="container">
<div style="display: flex; justify-content: space-between; align-items: center;">
  <a href="https://github.com/ompomz/flowgazer2/"><h1>flowgazer</h1></a>
  <button onclick="showAuthUI()" style="color: #00796b; background-color: #e0f2f1; padding: 0.25rem 1rem;">ã™ã§ã«éµã‚’ãŠæŒã¡ã®æ–¹</button>
</div>
<p>ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ãŸã‚Šã€éµãƒšã‚¢ã‚’ä½œã£ã¦æŠ•ç¨¿ã—ãŸã‚Šã€ãµãã¼ã£ãŸã‚Šã§ãã‚‹ã‚ˆã€‚ä½œã£ãŸã®ã¯Geminiã¨ChatGPTã¨copilotã¨Claudeã¨ãŸã‚ƒã¨ã™ã¹ã¦ã®å­¦ç¿’å…ƒæ§˜æ–¹ã€‚</p>
<button 
  id="generate-trial-keypair" 
  class="full-width"
  style="background-color: #ff99cc; color: #fff; margin: 0.5rem 0;"
  onclick="generateAndLoginWithNewKeypair()"
>æ–°ã—ã„éµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¦è©¦ã™ï¼</button>
  <div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
  <span style="white-space: nowrap;">ã€€</span>
  <a id="npub-link" class="npub-link" target="_blank" rel="noreferrer" style="display: none;"></a>
  <span id="not-logged-in" style="color: #999;">è¦‹ã‚‹ã ã‘ãƒ¢ãƒ¼ãƒ‰</span>
</div>
<div style="display: flex;">
 <span style="white-space: nowrap;">å…¬é–‹éµï¼ˆnpubï¼‰</span>
 <span style="word-break: break-all;">
 <a id="npub-link" class="npub-link" target="_blank" rel="noreferrer"></a>
 <svg id="copy-npub-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="cursor: pointer; margin-left: 0.25rem; vertical-align: middle;">
 <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
 <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
 </svg></span>
</div>
<textarea id="new-post-content" rows="3" placeholder="ã„ã¾ãªã«ã—ã¦ã‚‹ï¼Ÿ" class="full-width" style="margin-top:0.5rem;"></textarea>
<button id="send-new-post" class="full-width">æŠ•ç¨¿</button>
<div id="settings-toggle-area">
<button id="show-settings">è©³ç´°è¨­å®šã‚’è¡¨ç¤º</button>
<button id="hide-settings" class="hidden">è©³ç´°è¨­å®šã‚’éš ã™</button>
</div>
<div id="advanced-settings" class="hidden">
<div class="flex-container">
<input list="relay-suggestions" id="relay-url" type="text">
<datalist id="relay-suggestions">
<option value="wss://r.kojira.io/">
<option value="wss://yabu.me/">
<option value="wss://relay-jp.nostr.wirednet.jp/">
<option value="wss://relay.damus.io">
<option value="wss://nos.lol/">
<option value="wss://relay.nostr.band/">
</datalist>
<button id="subscribe-relay" style="padding:0.25rem 0rem; width:4rem;">æ¥ç¶š</button></div>
<div style="display: flex; align-items: center; gap: 0.25rem; margin-left: 0.25rem;"><label for="auto-update-toggle">è‡ªå‹•æ›´æ–°ON</label><input type="checkbox" id="auto-update-toggle" checked style="vertical-align: middle;"><label for="filter-flowgazer-only" style="margin-left: 1rem;">via flowgazer ã—ã¼ã‚Šã“ã¿</label><input type="checkbox" id="filter-flowgazer-only" style="vertical-align: middle;"><label for="kind-7-content-input" style="margin-left: 1rem;">ãµãã¼ãƒãƒ¼ã‚¯(1æ–‡å­—ã¾ã§)</label><input id="kind-7-content-input" type="text" maxlength="1" style="font-size:0.8rem; padding:0.125rem; width:2rem; text-align:center;"></div>
<div class="flex-container">
  <textarea id="hex-filter" rows="3" placeholder="æŠ•ç¨¿è€…ã—ã¼ã‚Šã“ã¿(npub1â€¦,hexâ€¦)"></textarea>
  <div class="flex-container-matome">
    <button id="apply-filter" style="padding:0.25rem 0rem; width:4rem;">é©ç”¨</button>
    <button id="clear-filter" style="padding:0.25rem 0rem; width:4rem;">ã‚¯ãƒªã‚¢</button>
    <button id="load-follows" style="padding:0.25rem 0rem; width:4rem;">kind:3</button>
  </div>
</div>
</div>
</div>
<ul id="timeline"></ul>
<div id="tab-buttons" style="display: flex; gap: 0.5rem; margin: 0.5rem 0;">
  <button id="tab-home" class="tab-button active">ã¿ã‚“ãªã®ãƒ„ã‚¤ãƒ¼ãƒˆ</button>
  <button id="tab-myposts" class="tab-button">ãƒ„ã‚¤ãƒ¼ãƒˆ</button>
  <button id="tab-likes" class="tab-button">ãµãã¼ã‚‰ã‚Œ</button>
</div>
<style>
.tab-button {
  padding: 0.5rem 1rem;
  border: none;
  background: #ddd;
  cursor: pointer;
  border-radius: 4px;
}
.tab-button.active {
  background: #66b3ff;
  color: #fff;
}
</style>  
<button id="cancel-loading" class="hidden full-width">ã‚ãã‚‰ã‚ã‚‹</button>
<button id="load-more" class="loading full-width">ã‚‚ã£ã¨è¦‹ã‚‹</button>

<script src="https://ompomz.github.io/header/loadHeader.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/tutorial.js"></script>
<script src="https://ompomz.github.io/flowgazer/stop.js"></script>
<script src="https://ompomz.github.io/flowgazer2/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer2/auth-ui.js"></script>
<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>
<script>
const npubLink = document.getElementById('npub-link');
const autoUpdateToggle = document.getElementById('auto-update-toggle');
const postContentInput = document.getElementById("new-post-content");
const sendPostButton = document.getElementById("send-new-post");
const flowgazerOnlyCheckbox = document.getElementById('filter-flowgazer-only');
const relayUrlInput = document.getElementById("relay-url");
const subscribeButton = document.getElementById("subscribe-relay");
const keypairArea = document.getElementById("keypair-area");
const showSettingsBtn = document.getElementById("show-settings");
const hideSettingsBtn = document.getElementById("hide-settings");
const settingsArea = document.getElementById("advanced-settings");
const hexFilterInput = document.getElementById("hex-filter");
const applyFilterButton = document.getElementById("apply-filter");
const clearFilterButton = document.getElementById("clear-filter");
const loadMoreButton = document.getElementById("load-more");
const cancelLoadingButton = document.getElementById('cancel-loading');
const timeline = document.getElementById("timeline");
const kind7ContentInput = document.getElementById("kind-7-content-input");
if (timeline === null) {
  throw new Error("no #timeline")
}
let forbiddenWords = [];
let isFlowgazerOnly = !1;
let isAutoLoading = !1;
var supportedKinds = [1, 6];
var profiles = {};
var events = {};
var filteredAuthors = null;
var oldestCreatedAt = Number.MAX_VALUE;
var relayWS;
var lastHighlightedEventId;
var MAIN_SUB_ID = "motherfuncking-main-sub";
var MORE_POSTS_SUB_ID = "motherfuncking-more-posts";
var PROFILE_SUB_ID = "motherfuncking-profile-sub";
var LS_RELAY_URL_KEY = "relayUrl";
let pressTimer;
// æ—¢å­˜ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å¾Œã«è¿½åŠ 
let currentTab = 'home'; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–
let myPostsEvents = {}; // è‡ªåˆ†ã®æŠ•ç¨¿ã‚’æ ¼ç´
let reactionCounts = {}; // { eventId: { reposts: 0, reactions: 0 } }
  
const likedEventIds = new Set();
let hasSubscribedLikes = !1;
let getDisplayName = (pubkey) => {
  return pubkey.substring(0, 8)
};
let fetchProfilesForPubkeys = () => {};
try {
  import('https://ompomz.github.io/flowgazer/displayname.js').then(module => {
    getDisplayName = (pubkey) => module.getDisplayName(pubkey, profiles);
    fetchProfilesForPubkeys = (pubkeys) => module.fetchProfilesForPubkeys(pubkeys, profiles, refreshTimeline);
    console.log('displayname.jsãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã¯displayname.jsãŒç®¡ç†ã—ã¾ã™ã€‚')
  }).catch(err => {
    console.warn('displayname.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åã¯å…¬é–‹éµã®çŸ­ç¸®å½¢ã«ãªã‚Šã¾ã™ã€‚', err)
  })
} catch (e) {
  console.warn('displayname.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒå‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¯¾å¿œã—ã¦ã„ãªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚', e)
}

function getLanguage() {
  return (window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage).substring(0, 2)
}
async function fetchForbiddenWords() {
  const url = 'https://ompomz.github.io/flowgazer/nglist.xml';
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    const xmlText = await response.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
    const termNodes = xmlDoc.querySelectorAll('term');
    forbiddenWords = Array.from(termNodes).map(node => node.textContent);
    console.log('ç¦æ­¢ç”¨èªãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚')
  } catch (error) {
    console.error('ç¦æ­¢ç”¨èªãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
  }
}


function formatTimestamp(date) {
  return String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ":" + String(date.getSeconds()).padStart(2, "0")
}
function findTagWithValue(tags, name, value, extraPred) {
  for (var i = 0; i < tags.length; i++) {
    var tag = tags[i];
    if (tag[0] === name && tag[1] === value && (extraPred ? extraPred(tag) : !0)) {
      return tag
    }
  }
  return undefined
}
function baseEventView() {
  var li = document.createElement("li");
  li.classList.add("event");
  return li
}
function externalLink(url, text) {
  var a = document.createElement("a");
  a.href = url;
  a.target = "_blank";
  a.rel = "noreferrer";
  a.textContent = text;
  return a
}
function timestampView(unixtime, eventId) {
  var ts = new Date(unixtime * 1000);
  var timeElem = document.createElement("a");
  timeElem.classList.add("nostr-ref");
  const currentRelay = relayUrlInput.value;
  const neventEncoded = window.NostrTools.nip19.neventEncode({
    id: eventId,
    relays: [currentRelay]
  });
  timeElem.href = "https://ompomz.github.io/tweetsrecap/tweet?id=" + neventEncoded;
  timeElem.setAttribute("datetime", ts.toISOString());
  timeElem.textContent = "[" + formatTimestamp(ts) + "]";
  timeElem.target = "_blank";
  timeElem.rel = "noreferrer";
  return timeElem
}
function pubkeyView(pubkey) {
  var npub = window.NostrTools.nip19.npubEncode(pubkey);
  var displayName = getDisplayName(pubkey);
  var sanitizedName = displayName.replace(/\p{Emoji_Presentation}/gu, "");
  if (sanitizedName.length === 0) {
    sanitizedName = pubkey.substring(0, 8)
  } else {
    const isAsciiOnly = /^[\x00-\x7F]*$/.test(sanitizedName);
    const maxLength = isAsciiOnly ? 12 : 6;
    sanitizedName = sanitizedName.substring(0, maxLength)
  }
  var a = externalLink("https://ompomz.github.io/tweetsrecap/tweet?id=" + npub, sanitizedName);
  a.classList.add("pubkey-ref");
  var hue = parseInt(pubkey.substring(0, 2), 16) * 360 / 256;
  var lightness = (hue >= 50 && hue <= 190) ? 45 : 60;
  a.style.color = `hsl(${hue}, 95%, ${lightness}%)`;
  return a
}
function metadataView(nostrEv) {
  var view = document.createElement("span");
  view.appendChild(timestampView(nostrEv.created_at, nostrEv.id));
  view.appendChild(document.createTextNode(" "));
  view.appendChild(pubkeyView(nostrEv.pubkey));
  view.appendChild(document.createTextNode(" > "));
  return view
}
var contentRefPattern = /(https?:\/\/[^\s]+)|(nostr:[\w]+1[ac-hj-np-z02-9]+)|(:[_a-zA-Z0-9]+:)/;
function indexOfFirstUnmatchingCloseParen(url) {
  var nest = 0;
  for (var i = 0; i < url.length; i++) {
    var c = url.charAt(i);
    if (c === "(") {
      nest++
    } else if (c === ")") {
      if (nest <= 0) {
        return i
      }
      nest--
    }
  }
  return -1
}
function urlLinkElems(url) {
  var splitIdx = indexOfFirstUnmatchingCloseParen(url);
  var finalUrl = splitIdx == -1 ? url : url.substring(0, splitIdx);
  var rest = splitIdx == -1 ? "" : url.substring(splitIdx);
  const isImage = (finalUrl.match(/\.(jpeg|jpg|gif|png|webp|avif)$/i) !== null);
  if (isImage) {
    var expandLink = document.createElement("a");
    expandLink.textContent = "[ç”»åƒã‚’è¡¨ç¤º]";
    expandLink.href = "#";
    expandLink.classList.add("nostr-ref");
    expandLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(finalUrl)
    });
    var link = externalLink(finalUrl, "æ–°ã—ã„ã‚¿ãƒ–ã§ã²ã‚‰ã");
    link.classList.add("nostr-ref");
    if (rest.length === 0) {
      return [expandLink, document.createTextNode(" "), link]
    } else {
      var restSpan = document.createElement("span");
      restSpan.textContent = rest;
      return [expandLink, document.createTextNode(" "), link, restSpan]
    }
  } else {
    var link = externalLink(finalUrl, finalUrl);
    link.classList.add("nostr-ref");
    if (rest.length === 0) {
      return [link]
    } else {
      var restSpan = document.createElement("span");
      restSpan.textContent = rest;
      return [link, restSpan]
    }
  }
}
function extractEventRef(nip19Decoded) {
  switch (nip19Decoded.type) {
    case "nevent":
      return {
        id: nip19Decoded.data.id,
        author: nip19Decoded.data.author
      };
    case "note":
      return {
        id: nip19Decoded.data
      };
    default:
      return undefined
  }
}
function extractReplyRef(tags) {
  var root;
  for (var i = 0; i < tags.length; i++) {
    var tag = tags[i];
    if (tag[0] !== "e") {
      continue
    }
    if (tag[3] === "reply" && typeof tag[1] === "string") {
      return {
        id: tag[1],
        author: typeof tag[4] === "string" ? tag[4] : undefined
      }
    }
    if (root === undefined && tag[3] === "root" && typeof tag[1] === "string") {
      root = {
        id: tag[1],
        author: typeof tag[4] === "string" ? tag[4] : undefined
      }
    }
  }
  return root
}
function nostrRefLink(nip19Id, idType) {
  var abbrId = nip19Id.substring(0, idType.length + 8) + "...";
  var a = externalLink("https://ompomz.github.io/tweetsrecap/tweet?id=" + nip19Id, "nostr:" + abbrId);
  a.classList.add("nostr-ref");
  return a
}
function nostrEventRefLink(nip19id, idType, hexEventId) {
  var abbrId = nip19id.substring(0, idType.length + 8) + "...";
  var a = document.createElement("a");
  a.textContent = "nostr:" + abbrId;
  a.classList.add("nostr-ref");
  if (document.getElementById(hexEventId)) {
    a.href = "#" + hexEventId
  } else {
    a.href = "https://ompomz.github.io/tweetsrecap/tweet?id=" + nip19id;
    a.target = "_blank";
    a.rel = "noreferrer"
  }
  return a
}
function pubkeyMention(pubkey) {
  var pubkeyRef = pubkeyView(pubkey);
  pubkeyRef.classList.add("pubkey-mention");
  return pubkeyRef
}
function referentAuthor(pubkey) {
  var span = document.createElement("span");
  span.appendChild(document.createTextNode(" by "));
  span.appendChild(pubkeyView(pubkey));
  return span
}
function inReplyToElems(nostrEv) {
  var replyRef = extractReplyRef(nostrEv.tags);
  if (replyRef === undefined) {
    return []
  }
  var replySuffix = document.createElement("span");
  replySuffix.textContent = "<< ";
  replySuffix.classList.add("reply-suffix");
  var nevent = window.NostrTools.nip19.neventEncode(replyRef);
  var replyLink = nostrEventRefLink(nevent, "nevent", replyRef.id);
  if (!replyRef.author) {
    return [replyLink, replySuffix]
  }
  return [replyLink, referentAuthor(replyRef.author), replySuffix]
}
function postQuotationElems(nip19Id, idType, hexEventId, author) {
  var prefix = document.createElement("span");
  prefix.textContent = "QP: ";
  prefix.classList.add("quote-prefix");
  var link = nostrEventRefLink(nip19Id, idType, hexEventId);
  if (!author) {
    return [prefix, link]
  }
  return [prefix, link, referentAuthor(author)]
}
function nostrUriElems(ref, nostrEv) {
  var nip19Id = ref.substring(6);
  var dec;
  try {
    dec = window.NostrTools.nip19.decode(nip19Id)
  } catch (err) {
    console.error("failed to decode NIP-19 ID:", err);
    return [document.createTextNode(ref)]
  }
  switch (dec.type) {
    case "npub":
      return [pubkeyMention(dec.data)];
    case "nprofile":
      return [pubkeyMention(dec.data.pubkey)];
    case "note":
    case "nevent":
      var evRef = extractEventRef(dec);
      if (evRef === undefined) {
        console.error("unreachable");
        return [nostrRefLink(nip19Id, dec.type)]
      }
      var mentionTag = findTagWithValue(nostrEv.tags, "e", evRef.id, function(t) {
        t[3] === "mention"
      });
      var author = (mentionTag && mentionTag[4]) || evRef.author;
      return postQuotationElems(nip19Id, dec.type, evRef.id, evRef.author);
    default:
      return [nostrRefLink(nip19Id, dec.type)]
  }
}
function customEmojiElems(shortcode, nostrEv) {
  var emojiName = shortcode.substring(1, shortcode.length - 1);
  for (var i = 0; i < nostrEv.tags.length; i++) {
    var tag = nostrEv.tags[i];
    if (tag[0] === "emoji" && tag[1] === emojiName && typeof tag[2] === "string") {
      var img = document.createElement('img');
      img.src = tag[2];
      img.alt = shortcode;
      img.classList.add("custom-emoji");
      return [img]
    }
  }
  return [document.createTextNode(shortcode)]
}
function postEventView(nostrEv) {
  var view = baseEventView();
  view.id = nostrEv.id;
  view.classList.add("event-post");
  let pressTimer;
  view.addEventListener('mousedown', (e) => {
    if (e.target.tagName === 'A') {
      return
    }
    if (e.button !== 0) {
      return
    }
    pressTimer = setTimeout(() => {
      clearTimeout(pressTimer);
      if (confirm("â˜†ãµãã¼ã‚‹ï¼Ÿâ€»ãµãã¼ã‚‹ã«ã¯éµãŒå¿…è¦ã§ã™ã€‚")) {
        sendLikeEvent(nostrEv.id, nostrEv.pubkey)
      }
    }, 800)
  });
  view.addEventListener('mouseup', () => {
    clearTimeout(pressTimer)
  });
  view.addEventListener('mouseleave', () => {
    clearTimeout(pressTimer)
  });
  view.addEventListener('touchstart', (e) => {
    pressTimer = setTimeout(() => {
      clearTimeout(pressTimer);
      if (confirm("â˜†ãµãã¼ã‚‹ï¼Ÿâ€»ãµãã¼ã‚‹ã«ã¯éµãŒå¿…è¦ã§ã™ã€‚")) {
        sendLikeEvent(nostrEv.id, nostrEv.pubkey)
      }
    }, 800)
  }, {
    passive: !0
  });
  view.addEventListener('touchend', () => {
    clearTimeout(pressTimer)
  });
  view.addEventListener('touchcancel', () => {
    clearTimeout(pressTimer)
  });
  view.appendChild(metadataView(nostrEv));
  inReplyToElems(nostrEv).forEach(e => view.appendChild(e));
  var contentElems = nostrEv.content.split(contentRefPattern).filter(s => s !== undefined && s.length > 0).flatMap(s => {
    if (s.indexOf("http") === 0) {
      return urlLinkElems(s)
    }
    if (s.indexOf("nostr:") === 0) {
      return nostrUriElems(s, nostrEv)
    }
    if (s.charAt(0) === ":" && s.charAt(s.length - 1) === ":") {
      return customEmojiElems(s, nostrEv)
    }
    return [document.createTextNode(s)]
  });
  contentElems.forEach(elem => view.appendChild(elem));
  return view
}
function repostEventView(nostrEv) {
  var targetPostId;
  var targetPostAuthor;
  for (var i = 0; i < nostrEv.tags.length; i++) {
    var tag = nostrEv.tags[i];
    if (tag[0] === "e" && typeof tag[1] === "string") targetPostId = tag[1];
    if (tag[0] === "p" && typeof tag[1] === "string") targetPostAuthor = tag[1];
    if (targetPostId && targetPostAuthor) break
  }
  if (targetPostId === undefined) {
    console.error("repost without target post ID:", nostrEv);
    return undefined
  }
  var view = baseEventView();
  view.classList.add("event-repost");
  view.appendChild(metadataView(nostrEv));
  var repostPrefix = document.createElement("span");
  repostPrefix.textContent = "RP: ";
  repostPrefix.classList.add("repost-prefix");
  var nevent = window.NostrTools.nip19.neventEncode({
    id: targetPostId
  });
  var repostLink = nostrEventRefLink(nevent, "nevent", targetPostId);
  view.appendChild(repostPrefix);
  view.appendChild(repostLink);
  if (targetPostAuthor) view.appendChild(referentAuthor(targetPostAuthor));
  return view
}

async function sendLikeEvent(targetEventId, targetPubkey) {
  if (!window.nostrAuth.canWrite()) { // â† isLoggedIn() ã‹ã‚‰å¤‰æ›´
    alert("ãµãã¼ã‚‹ã«ã¯ç§˜å¯†éµã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
    showAuthUI();
    return;
  }

  if (!hasSubscribedLikes) {
    subscribeLikes(window.nostrAuth.pubkey);
    hasSubscribedLikes = true;
  }

  const kind7Content = kind7ContentInput.value.trim() === '' ? '+' : kind7ContentInput.value.trim();

  try {
    const likeEvent = {
      kind: 7,
      content: kind7Content,
      created_at: Math.floor(Date.now() / 1000),
      tags: [
        ["e", targetEventId],
        ["p", targetPubkey]
      ]
    };

    const signedEvent = await window.nostrAuth.signEvent(likeEvent);
    relayWS.send(JSON.stringify(["EVENT", signedEvent]));
    likedEventIds.add(targetEventId);
    refreshTimeline();
    alert("ãµãã¼ã£ãŸï¼");
  } catch (err) {
    console.error("ãµãã¼ã«å¤±æ•—:", err);
    alert("ãµãã¼ã‚Œãªã‹ã£ãŸ: " + err.message);
  }
}
  
function subscribeLikes(myPubkey) {
  if (!myPubkey || !relayWS || relayWS.readyState !== WebSocket.OPEN) {
    console.error("Failed to subscribe to likes: Invalid pubkey or relay not open.");
    return
  }
  const LIKES_SUB_ID = "motherfuncking-likes-sub";
  const likeFilter = {
    kinds: [7],
    authors: [myPubkey],
  };
  relayWS.send(JSON.stringify(["REQ", LIKES_SUB_ID, likeFilter]));
  console.log("Kind:7ã‚¤ãƒ™ãƒ³ãƒˆã®è³¼èª­ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", myPubkey)
}
function onEvent(nostrEv, prepend) {
  if (!window.NostrTools.verifyEvent(nostrEv)) {
    console.error("nostr event with invalid signature:", nostrEv);
    return
  }
  if (nostrEv.kind === 1) {
    if (nostrEv.content.length > 200) {
      console.log(`æŠ•ç¨¿ã®æ–‡å­—æ•°ãŒ200æ–‡å­—ã‚’è¶Šãˆã¦ã„ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
      return
    }
    if (forbiddenWords.some(word => nostrEv.content.includes(word))) {
      console.log('æŠ•ç¨¿ãŒç¦æ­¢ç”¨èªã‚’å«ã‚“ã§ã„ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
      return
    }
  }
  if (nostrEv.kind === 0) {
    return
  }
  if (nostrEv.kind === 7) {
    const eTag = nostrEv.tags.find(tag => tag[0] === 'e');
    if (eTag) {
      likedEventIds.add(eTag[1])
    }
    refreshTimeline();
    return
  }
  if (supportedKinds.indexOf(nostrEv.kind) === -1) {
    console.error("unsupported kind:", nostrEv.kind);
    return
  }
  if (events[nostrEv.id]) return;
  events[nostrEv.id] = nostrEv;
  oldestCreatedAt = Math.min(oldestCreatedAt, nostrEv.created_at);
  if (!profiles[nostrEv.pubkey]) {
    fetchProfilesForPubkeys([nostrEv.pubkey])
  }
  refreshTimeline()
}

function refreshTimeline() {
  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
  while (timeline.firstChild) {
    timeline.removeChild(timeline.firstChild);
  }
  
  let displayedEvents;
  
  // ã‚¿ãƒ–ã«å¿œã˜ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
  if (currentTab === 'myposts') {
    // ãƒã‚¤ãƒã‚¹ãƒˆã‚¿ãƒ–ï¼šè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿
    displayedEvents = Object.values(myPostsEvents);
    
  } else if (currentTab === 'home') {
    // ãƒ›ãƒ¼ãƒ ã‚¿ãƒ–ï¼šæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
    displayedEvents = Object.values(events).filter(e => {
      if (isFlowgazerOnly) {
        const isFlowgazerPost = (e.kind === 1 && e.tags.some(tag => tag[0] === 'client' && tag[1] === 'flowgazer'));
        return isFlowgazerPost;
      }
      return e.kind === 1 || e.kind === 6;
    });
    
  } else {
    // ãã®ä»–ã®ã‚¿ãƒ–ï¼ˆå°†æ¥ã®ãµãã¼ã‚¿ãƒ–ãªã©ï¼‰
    displayedEvents = [];
  }
  
  // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedEvents = displayedEvents.sort((a, b) => b.created_at - a.created_at);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æç”»
  sortedEvents.forEach(e => {
    let eventView;
    
    if (e.kind === 1) {
      eventView = postEventView(e);
      
      if (eventView) {
        // ãµãã¼æ¸ˆã¿ãªã‚‰é»„è‰²ã„æ 
        if (likedEventIds.has(e.id)) {
          eventView.classList.add('event-liked');
        }
        
        // ã€é‡è¦ã€‘ãƒã‚¤ãƒã‚¹ãƒˆã‚¿ãƒ–ã®å ´åˆã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º
        if (currentTab === 'myposts' && reactionCounts[e.id]) {
          const counts = reactionCounts[e.id];
          const badge = document.createElement('span');
          badge.textContent = ` ğŸ”${counts.reposts} â­${counts.reactions}`;
          badge.style.cssText = 'color: #999; margin-left: 0.5rem; font-size: 0.8rem;';
          eventView.appendChild(badge);
        }
        
        timeline.appendChild(eventView);
      }
      
    } else if (e.kind === 6) {
      eventView = repostEventView(e);
      if (eventView) timeline.appendChild(eventView);
    }
  });
}
  
function onWSClose() {
  alert("Relay connection closed")
}
function isKnownSubId(subId) {
  return subId === MAIN_SUB_ID || subId === MORE_POSTS_SUB_ID || subId === PROFILE_SUB_ID || subId === "motherfuncking-likes-sub"
}
function shouldPrependPost(subId, afterEose) {
  return subId === MAIN_SUB_ID && afterEose
}
function subscribeRelay(relayUrl, authors) {
  if (relayWS) {
    while (timeline.firstChild) timeline.removeChild(timeline.firstChild);
    relayWS.removeEventListener("close", onWSClose);
    relayWS.close()
  }
  try {
    relayWS = new WebSocket(relayUrl)
  } catch (err) {
    console.error("failed to connect to relay:", err);
    alert("Failed to connect to relay:", relayUrl);
    return
  }
  events = {};
  oldestCreatedAt = Number.MAX_VALUE;
  var afterEose = !1;
  var filters = [{
    kinds: [1, 6],
    limit: 50
  }];
  if (authors && authors.length > 0) {
    filters[0].authors = authors
  }
  relayWS.addEventListener("open", () => {
    relayWS.send(JSON.stringify(["REQ", MAIN_SUB_ID, ...filters]))
  });
  relayWS.addEventListener("message", ev => {
    try {
      var r2cMsg = JSON.parse(ev.data);
      switch (r2cMsg[0]) {
        case "EVENT":
          var subId = r2cMsg[1];
          if (!isKnownSubId(subId)) return;
          onEvent(r2cMsg[2], shouldPrependPost(subId, afterEose));
          break;
        case "EOSE":
          var subId = r2cMsg[1];
          if (subId === MAIN_SUB_ID) {
            afterEose = !0;
            checkForAutoLoad()
          } else if (subId === MORE_POSTS_SUB_ID) {
            checkForAutoLoad()
          }
          loadMoreButton.classList.remove("loading");
          break;
        default:
          console.log(r2cMsg);
          break
      }
    } catch (err) {
      console.error(err)
    }
  });
  relayWS.addEventListener("close", onWSClose)
}
function filterAuthors() {
  const inputText = hexFilterInput.value;
  if (!inputText.trim()) return [];
  const authors = inputText.split(/[ , \n]/);
  return authors.map(hex => {
    hex = hex.trim();
    if (hex.startsWith('npub') || hex.startsWith('nprofile')) {
      try {
        const decoded = NostrTools.nip19.decode(hex);
        return decoded.type === 'npub' ? decoded.data : (decoded.type === 'nprofile' ? decoded.data.pubkey : null)
      } catch (e) {
        return null
      }
    }
    return hex.length === 64 && /^[0-9a-fA-F]{64}$/.test(hex) ? hex : null
  }).filter(Boolean)
}

async function sendeNewPost() {
  if (!window.nostrAuth.canWrite()) { // â† isLoggedIn() ã‹ã‚‰å¤‰æ›´
    alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ç§˜å¯†éµã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
    showAuthUI();
    return;
  }

  const content = postContentInput.value;
  if (!content) {
    alert("æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
    const post = {
      kind: 1,
      content: content,
      created_at: Math.floor(Date.now() / 1000),
      tags: [
        ["client", "flowgazer", "31990:a19caaa8404721584746fb0e174cf971a94e0f51baaf4c4e8c6e54fa88985eaf:1755917022711", "wss://relay.nostr.band/"]
      ]
    };

    const signedPost = await window.nostrAuth.signEvent(post);
    relayWS.send(JSON.stringify(["EVENT", signedPost]));
    postContentInput.value = "";
    alert('æŠ•ç¨¿ã«æˆåŠŸã—ã¾ã—ãŸï¼');
  } catch (err) {
    console.error(err);
    alert("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  }
}

function checkForAutoLoad() {
  const displayedEventsCount = timeline.children.length;
  if (isAutoLoading && displayedEventsCount < 5) {
    console.log("Auto-loading next page...");
    setTimeout(() => {
      if (isAutoLoading) {
        loadMoreButton.click()
      }
    }, 1000)
  } else {
    isAutoLoading = !1;
    cancelLoadingButton.style.display = 'none'
  }
}

// æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼šéµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
function generateAndLoginWithNewKeypair() {
  const confirmed = confirm(
    'æ–°ã—ã„éµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\n\n' +
    'ç”Ÿæˆã•ã‚ŒãŸç§˜å¯†éµï¼ˆnsecï¼‰ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ¶ˆãˆã¾ã™ã€‚' +
    'å¿…ãšã‚³ãƒ”ãƒ¼ã—ã¦å®‰å…¨ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚\n\n'
  );
  
  if (!confirmed) return;
  
  // éµãƒšã‚¢ã‚’ç”Ÿæˆ
  const seckey = window.NostrTools.generateSecretKey();
  const pubkey = window.NostrTools.getPublicKey(seckey);
  const nsec = window.NostrTools.nip19.nsecEncode(seckey);
  const npub = window.NostrTools.nip19.npubEncode(pubkey);
  
  // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³
  window.nostrAuth.loginWithNsec(nsec);
  
  // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
  location.reload();
}

function updateLoginUI() {
  const notLoggedInSpan = document.getElementById('not-logged-in');
  if (window.nostrAuth.isLoggedIn()) {
    const npub = NostrTools.nip19.npubEncode(window.nostrAuth.pubkey);
    npubLink.textContent = npub.substring(0, 12) + '...' + npub.slice(-4);
    npubLink.href = "https://nostter.app/" + npub;
    npubLink.style.display = "inline";
    notLoggedInSpan.style.display = "none";

    if (window.nostrAuth.useNIP07) {
      window.nostrSigner = window.nostr;
    }
  } else {
    npubLink.style.display = "none";
    notLoggedInSpan.style.display = "inline";
  }
}

window.addEventListener('DOMContentLoaded', () => {
  updateLoginUI(); // â† ã“ã‚Œã ã‘ã§OKï¼

  // ä»¥ä¸‹ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾
  document.getElementById('hide-settings').classList.add('hidden');
  document.getElementById('advanced-settings').classList.add('hidden');
  
  const links = document.querySelectorAll('a');
  links.forEach(link => {
    if (!link.target || link.target === '_self') {
      link.setAttribute('target', '_blank')
    }
    if (!link.rel) {
      link.setAttribute('rel', 'noopener noreferrer')
    }
  });
  
  flowgazerOnlyCheckbox.checked = false;
  const savedFilter = localStorage.getItem('hexFilterValue');
  if (savedFilter) {
    hexFilterInput.value = savedFilter;
  }
  
  fetchForbiddenWords();
  const latestRurl = localStorage.getItem(LS_RELAY_URL_KEY);
  const defaultRurl = getLanguage() === "ja" ? "wss://r.kojira.io" : "wss://nos.lol/";
  const initialRurl = latestRurl || defaultRurl;
  relayUrlInput.value = initialRurl;
  subscribeRelay(initialRurl);
  
  if (kind7ContentInput) {
    kind7ContentInput.value = 'â­';
  }
  // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      // å…¨ã‚¿ãƒ–ã®activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      e.target.classList.add('active');
      
      // currentTabå¤‰æ•°ã‚’æ›´æ–°ï¼ˆ'tab-home' â†’ 'home'ï¼‰
      currentTab = e.target.id.replace('tab-', '');
      
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»
      refreshTimeline();
      
      // ãƒã‚¤ãƒã‚¹ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã«è‡ªå‹•å–å¾—
      if (currentTab === 'myposts' && Object.keys(myPostsEvents).length === 0) {
        fetchMyPosts();
      }
    });
  });
  
  // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰è‡ªå‹•ã§è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å–å¾—
  if (window.nostrAuth.isLoggedIn()) {
    fetchMyPosts();
  }
});

  /**
 * è‡ªåˆ†ã®æŠ•ç¨¿ï¼ˆkind:1ï¼‰ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆkind:6,7ï¼‰ã‚’å–å¾—
 */
async function fetchMyPosts() {
  if (!window.nostrAuth.isLoggedIn()) {
    console.log('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãŸã‚ã€ãƒã‚¤ãƒã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    return;
  }
  
  const myPubkey = window.nostrAuth.pubkey;
  const currentRelay = relayUrlInput.value;
  
  console.log('è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å–å¾—ä¸­...', myPubkey);
  
  const ws = new WebSocket(currentRelay);
  
  ws.onopen = () => {
    console.log('ãƒã‚¤ãƒã‚¹ãƒˆå–å¾—ç”¨WebSocketæ¥ç¶šæˆåŠŸ');
    
    // 1. è‡ªåˆ†ã®kind:1ã‚’å–å¾—
    ws.send(JSON.stringify(['REQ', 'my-posts-sub', {
      kinds: [1],
      authors: [myPubkey],
      limit: 100 // æœ€æ–°100ä»¶
    }]));
  };
  
  ws.onmessage = (ev) => {
    const [type, subId, event] = JSON.parse(ev.data);
    
    if (type === 'EVENT' && subId === 'my-posts-sub') {
      // è‡ªåˆ†ã®æŠ•ç¨¿ã‚’ä¿å­˜
      myPostsEvents[event.id] = event;
      
    } else if (type === 'EOSE' && subId === 'my-posts-sub') {
      console.log(`è‡ªåˆ†ã®æŠ•ç¨¿ã‚’${Object.keys(myPostsEvents).length}ä»¶å–å¾—ã—ã¾ã—ãŸ`);
      
      // 2. å–å¾—ã—ãŸæŠ•ç¨¿ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆkind:6,7ï¼‰ã‚’å–å¾—
      const myEventIds = Object.keys(myPostsEvents);
      
      if (myEventIds.length > 0) {
        console.log('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ä¸­...');
        ws.send(JSON.stringify(['REQ', 'my-reactions-sub', {
          kinds: [6, 7],
          '#e': myEventIds // è‡ªåˆ†ã®æŠ•ç¨¿IDã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
        }]));
      } else {
        ws.close();
        refreshTimeline();
      }
      
    } else if (type === 'EVENT' && subId === 'my-reactions-sub') {
      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const targetId = event.tags.find(t => t[0] === 'e')?.[1];
      
      if (targetId) {
        // åˆæœŸåŒ–
        if (!reactionCounts[targetId]) {
          reactionCounts[targetId] = { reposts: 0, reactions: 0 };
        }
        
        // ã‚«ã‚¦ãƒ³ãƒˆ
        if (event.kind === 6) {
          reactionCounts[targetId].reposts++;
        } else if (event.kind === 7) {
          reactionCounts[targetId].reactions++;
        }
      }
      
    } else if (type === 'EOSE' && subId === 'my-reactions-sub') {
      console.log('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å–å¾—å®Œäº†:', reactionCounts);
      ws.close();
      
      // ãƒã‚¤ãƒã‚¹ãƒˆã‚¿ãƒ–ã‚’è¡¨ç¤ºä¸­ãªã‚‰å†æç”»
      if (currentTab === 'myposts') {
        refreshTimeline();
      }
    }
  };
  
  ws.onerror = (err) => {
    console.error('ãƒã‚¤ãƒã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
  };
  
  ws.onclose = () => {
    console.log('ãƒã‚¤ãƒã‚¹ãƒˆå–å¾—ç”¨WebSocketåˆ‡æ–­');
  };
}

sendPostButton.addEventListener("click", sendeNewPost);
postContentInput.addEventListener('keydown', (e) => {
  const isModifierPressed = e.ctrlKey || e.metaKey;
  const isEnterPressed = e.key === 'Enter';
  if (isModifierPressed && isEnterPressed) {
    e.preventDefault();
    sendeNewPost()
  }
});
subscribeButton.addEventListener("click", () => {
  if (!autoUpdateToggle.checked) {
    autoUpdateToggle.checked = !0;
    console.log("subscribe-relayãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸãŸã‚ã€è‡ªå‹•æ›´æ–°ã‚’ONã«ã—ã¾ã—ãŸã€‚")
  }
  const rurl = relayUrlInput.value;
  subscribeRelay(rurl);
  localStorage.setItem(LS_RELAY_URL_KEY, rurl)
});
autoUpdateToggle.addEventListener('change', function() {
  if (this.checked) {
    console.log("è‡ªå‹•æ›´æ–°ON");
    const rurl = relayUrlInput.value;
    subscribeRelay(rurl, filteredAuthors);
    localStorage.setItem(LS_RELAY_URL_KEY, rurl)
  } else {
    if (typeof stopAutoLoading === 'function') {
      stopAutoLoading()
    }
  }
});
flowgazerOnlyCheckbox.addEventListener('change', function() {
  isFlowgazerOnly = this.checked;
  refreshTimeline()
});
showSettingsBtn.addEventListener("click", () => {
  settingsArea.classList.remove("hidden");
  showSettingsBtn.classList.add("hidden");
  hideSettingsBtn.classList.remove("hidden")
});
hideSettingsBtn.addEventListener("click", () => {
  settingsArea.classList.add("hidden");
  hideSettingsBtn.classList.add("hidden");
  showSettingsBtn.classList.remove("hidden")
});
applyFilterButton.addEventListener("click", () => {
  if (!autoUpdateToggle.checked) {
    autoUpdateToggle.checked = !0;
    console.log("apply-filterãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸãŸã‚ã€è‡ªå‹•æ›´æ–°ã‚’ONã«ã—ã¾ã—ãŸã€‚")
  }
  filteredAuthors = filterAuthors();
  const rurl = relayUrlInput.value;
  localStorage.setItem('hexFilterValue', hexFilterInput.value);
  subscribeRelay(rurl, filteredAuthors)
});
clearFilterButton.addEventListener("click", () => {
  hexFilterInput.value = "";
  filteredAuthors = null;
  localStorage.removeItem('hexFilterValue');
  const rurl = relayUrlInput.value;
  subscribeRelay(rurl)
});
loadMoreButton.addEventListener("click", function() {
  if (!relayWS || relayWS.readyState !== WebSocket.OPEN) return;
  if (this.classList.contains("loading")) return;
  this.classList.add("loading");
  isAutoLoading = !0;
  cancelLoadingButton.style.display = 'inline';
  const filter = {
    kinds: [1, 6],
    until: oldestCreatedAt - 1,
    limit: 50
  };
  if (filteredAuthors && filteredAuthors.length > 0) filter.authors = filteredAuthors;
  const pubkeysToFetchInThisBatch = new Set();
  Object.values(events).forEach(e => {
    if (!profiles[e.pubkey]) {
      pubkeysToFetchInThisBatch.add(e.pubkey)
    }
  });
  if (pubkeysToFetchInThisBatch.size > 0) {
    fetchProfilesForPubkeys(Array.from(pubkeysToFetchInThisBatch))
  }
  relayWS.send(JSON.stringify(["REQ", MORE_POSTS_SUB_ID, filter]))
});
cancelLoadingButton.addEventListener('click', function() {
  isAutoLoading = !1;
  loadMoreButton.classList.remove('loading');
  this.style.display = 'none';
  if (relayWS.readyState === WebSocket.OPEN) {
    relayWS.send(JSON.stringify(["CLOSE", MORE_POSTS_SUB_ID]))
  }
});
window.addEventListener("hashchange", () => {
  if (window.location.hash.length === 0) return;
  const hash = window.location.hash.substring(1);
  if (hash.length === 0) return;
  if (lastHighlightedEventId) {
    const highlighted = document.getElementById(lastHighlightedEventId);
    if (highlighted) highlighted.classList.remove("event-highlighted")
  }
  const target = document.getElementById(hash);
  if (!target) return;
  lastHighlightedEventId = hash;
  target.classList.add("event-highlighted")
});
npubLink.addEventListener("click", event => {
  window.open(npubLink.href, "_blank")
});

  document.getElementById('load-follows').addEventListener('click', async () => {
  if (!window.nostrAuth.isLoggedIn()) {
    alert('éµã‚’å…¥ã‚Œã¦ã­');
    showAuthUI();
    return;
  }

  const myPubkey = window.nostrAuth.pubkey;
  
  try {
    // kind:3ã‚’å–å¾—
    const kind3Event = await new Promise((resolve, reject) => {
      const ws = new WebSocket(relayUrlInput.value);
      ws.onopen = () => {
        ws.send(JSON.stringify(['REQ', 'temp-kind3', {
          kinds: [3],
          authors: [myPubkey],
          limit: 1
        }]));
      };
      ws.onmessage = (ev) => {
        const [type, , event] = JSON.parse(ev.data);
        if (type === 'EVENT') resolve(event);
        if (type === 'EOSE') {
          ws.close();
          reject(new Error('kind:3ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'));
        }
      };
      setTimeout(() => reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 5000);
    });

    // pã‚¿ã‚°ã‹ã‚‰pubkeyã‚’æŠ½å‡º
    const follows = kind3Event.tags
      .filter(tag => tag[0] === 'p')
      .map(tag => tag[1])
      .join('\n');

    hexFilterInput.value = follows;
    alert(`${kind3Event.tags.length}äººã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    
  } catch (err) {
    alert('ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—: ' + err.message);
  }
});  
</script> 
<div id="tutorial-overlay">
  <div id="tutorial-modal">
    <div id="tutorial-close-button">ã¨ã˜ã‚‹</div>
    <div id="tutorial-content">
      <div id="image-container">
        <img src="image1.png" class="tutorial-image active">
        <img src="image2.png" class="tutorial-image">
        <img src="image3.png" class="tutorial-image">
      </div>
      <div id="dot-navigation" class="dot-navigation">
        <span class="dot active" data-index="0"></span>
        <span class="dot" data-index="1"></span>
        <span class="dot" data-index="2"></span>
      </div>
    </div>
  </div>
</div>
</body>
</html>
