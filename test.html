<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweetviewer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; line-height: 1.5; background-color: #f7f7f7; color: #666; font-size: 0.9rem; padding: 0.5rem; }
.container { max-width: 600px; margin: 0; padding: 0.5rem; border-radius: 4px; }
.container h1 { font-size: 1.3rem; }
.container h2 { font-size: 1.1rem; }
.container p { word-break: break-all; }
.container a { color: #66b3ff; text-decoration: none; }
.container a:hover { color: #4da6ff; text-decoration: underline; }
@media (max-width: 767px) { .container { max-width: 100%; } }
.container button { border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: background-color 0.3s ease, color 0.3s ease; }
.container button:hover { background-color: #ffa347; }
.header-section { display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px dashed #ddd; }
#main-event { padding: 0.5rem 0; }
#status { margin: 0.5rem 0rem; font-weight: bold; color: #ff99cc; }
.reactions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.25rem 0rem 0.75rem 0rem; }
.reactions-list img{ height: 1.25rem !important; object-fit: cover;}
.reaction-group { display: flex; align-items: center; background-color: #eee; border-radius: 999px; padding: 0.2rem 0.5rem; font-size: 0.8rem; }
.reaction-avatars { display: flex; flex-direction: row-reverse; }
.reaction-avatar { width: 1.25rem; height: 1.25rem; border-radius: 50%; object-fit: cover; display: block; margin: 0; }
.related-posts { margin: 0.5rem 0rem; }
.related-post-card { background-color: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem 0.5rem; margin: 0.5rem 0rem; }
.related-post-card .profile { display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0rem; }
.related-post-card .profile-name, .related-post-card .profile-npub { font-size: 0.8rem; }
.related-post-card .profile-image { width: 1.5rem; height: 1.5rem; }
.related-post-card .post-content { font-size: 0.8rem; margin: 0.5rem 0rem 0.75rem 0rem; }
.profile { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.profile-image { width: 2rem; height: 2rem; border-radius: 50%; object-fit: cover; }
.profile-name { font-weight: bold; font-size: 1rem; color: #444; }
.profile-nip05, .profile-npub { text-decoration: none !important; font-size: 0.8rem; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.profile-picture { width: 6rem; height: 6rem; border-radius: 50%; object-fit: cover; border: 3px solid rgba(0, 121, 107, 0.5); }
@media (max-width: 370px) { .profile-picture { width: 4.5rem; height: 4.5rem; } }
.profile-card { display: flex; flex-direction: column; gap: 1rem; padding: 1rem; background-color: #fff; border-radius: 8px; border: 1px solid #ddd; }
.profile-header { display: flex; align-items: center; gap: 1rem; }
.profile-info-container { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
.npub-container { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; word-break: break-all; padding: 0.25rem 0rem 0rem 0rem; }
.copy-icon { cursor: pointer; transition: opacity 0.2s ease; }
.copy-icon:hover { opacity: 0.4; }
.about-text { font-size: 0.9rem; line-height: 1.5; color: #333; word-break: break-all; }
.about-text a { color: #66b3ff; text-decoration: underline; }
.about-text a:hover { color: #4da6ff; }
.about-text .custom-emoji { height: 1.2rem; vertical-align: middle; }
.post-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #999; }
.post-content { margin: 0.5rem 0rem; line-height: 1.5; overflow-wrap: break-word; word-break: break-word; }
.post-content img { max-width: 15rem; max-height: 15rem; height: auto; display: block; margin: 0; }
.post-content img.custom-emoji { vertical-align: middle; display: inline-block; height: 1.2rem; }
.post-content ul, .post-content ol { list-style-position: inside; }
.nostr-form { display: flex; flex-direction: row; align-items: center; gap: 0.5rem; padding-top: 0.25rem; }
.form-input { flex: 1; min-width: 0; width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
.form-button { flex-shrink: 0; padding: 0.5rem 1.2rem !important; }
.footer-section { padding: 0.5rem 0; border-top: 1px dashed #ddd; }
.hidden { display: none; }
.modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.modal-content { margin: auto; display: block; max-width: 80%; max-height: 80vh; width: 80%; }
.modal-image { width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
.close-button { color: #fff; font-size: 40px; font-weight: 700; cursor: pointer; transition: 0.3s; }
.close-button:hover, .close-button:focus { color: #eee; text-decoration: none; cursor: pointer; }
.custom-emoji-hover:hover { transform: scale(2.0); z-index: 10; }
</style>
</head>
<body>
<div id="modal-placeholder"></div>

<div class="container">
    <div id="nav-section" class="header-section">
        <button id="btn-back">ã‚‚ã©ã‚‹</button>
        <button id="btn-share">ã‚·ã‚§ã‚¢</button>
        <button id="btn-auth" class="auth-button">éµã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰</button>
    </div>
    <div style="margin: 0.5rem 0rem;">
    <main id="main-content">
        <div id="loading-status" class="hidden"></div>
        <div id="render-area"></div>
    </main>

    <section id="sub-content" class="hidden">
        <div id="reactions-section">
            <div id="reactions-list"></div>
        </div>
        <div id="related-events-section">
            <div id="related-events-list"></div>
        </div>
    </section>
    </div>
    <div id="footer-section" class="footer-section">
        <button id="btn-back-footer">ã‚‚ã©ã‚‹</button>
        <button id="save-list-btn" style="display:none;">ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¿å­˜</button>
    </div>
</div>

<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth-ui.js"></script>
<script src="https://ompomz.github.io/flowgazer/relay-manager.js"></script>
<script src="https://ompomz.github.io/flowgazer/data-store.js"></script>
<script src="https://ompomz.github.io/flowgazer/profile-fetcher.js"></script>
<script src="./channel.js"></script>
<script src="./quote-manager.js"></script>

<script>

    const FALLBACK_RELAYS = [
        "wss://relay.damus.io/",
        "wss://nos.lol/",
        "wss://relay.nostr.band/"
    ];

    function setupFormListener() {
        const form = document.getElementById('nostr-form');
        if (!form) return;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('nostr-id-input').value.trim();
            if (input) {
                window.location.href = `?id=${input}`;
            }
        });
    }

    function showStatus(message) {
        const statusElement = document.getElementById('loading-status');
        if (!statusElement) return;

        statusElement.textContent = message;
        if (message) {
            statusElement.classList.remove('hidden');
        } else {
            statusElement.classList.add('hidden');
        }
    }

    // --- 1. IDåˆ¤åˆ¥ã¨ãƒ«ãƒ¼ãƒˆæŒ¯ã‚Šåˆ†ã‘ ---
    function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const renderArea = document.getElementById('render-area');

        // 1. IDãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        if (!id) {
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // 2. IDã®ç¨®é¡ã‚’åˆ¤å®šã—ã¦æŒ¯ã‚Šåˆ†ã‘
        try {
            const decoded = NostrTools.nip19.decode(id);

            switch (decoded.type) {
                case 'npub':
                case 'nprofile':
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startProfileWorkflow(decoded);
                    break;

                case 'note':
                case 'nevent':
                case 'naddr':
                    // æŠ•ç¨¿è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startEventWorkflow(decoded);
                    break;

                default:
                    showStatus('ã‚¨ãƒ©ãƒ¼: æœªå¯¾å¿œã®IDå½¢å¼ã§ã™ã€‚');
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
            }
        } catch (err) {
            showStatus('ã‚¨ãƒ©ãƒ¼: IDã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
        }
    }

    // --- 2. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (HTMLã‚’çµ„ã¿ç«‹ã¦ã‚‹å°‚é–€å®¶) ---
    const Components = {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        profileCard: (profile, npub) => {
            const picture = profile.picture || 'https://ompomz.github.io/favicon.ico';
            const name = profile.name || 'Unknown';
            const about = profile.about ? `<p class="about-text">${Components.utils.escape(profile.about).replace(/\n/g, '<br>')}</p>` : '';

            return `
            <div class="profile-card">
                <div class="profile-header">
                    <img src="${picture}" class="profile-picture">
                    <div class="profile-info">
                        <h2 class="profile-name">${name}</h2>
                        <code class="npub-text">${npub.substring(0, 12)}...</code>
                    </div>
                </div>
                ${about}
            </div>
        `;
        },

        // æŠ•ç¨¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰æœ¬ä½“ã®ç”Ÿæˆ
        eventBody: (event, contentHtml, profile = {}) => {
            const date = new Date(event.created_at * 1000).toLocaleString();
            const picture = profile.picture || 'https://ompomz.github.io/favicon.ico';
            const nameHtml = Components.utils.getNameLink(event.pubkey, profile);

            return `
        <div class="main-post">
            <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="${picture}" style="width: 48px; height: 48px; border-radius: 50%;">
                <div>
                    <div style="font-weight: bold;">${nameHtml}</div>
                    <div style="font-size: 0.8rem; color: #666;">@${NostrTools.nip19.npubEncode(event.pubkey).substring(0, 10)}...</div>
                </div>
            </div>
            <div class="post-content">${contentHtml}</div>
            <div class="post-footer" style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                <span>${date}</span>
            </div>
        </div>
        `;
        },

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ç”Ÿæˆ
        inputForm: () => `
        <div class="input-form-container">
            <p class="form-title">Nostr IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <form id="nostr-form" class="nostr-form">
                <input type="text" id="nostr-id-input" placeholder="nevent1..., npub1..." required class="form-input">
                <button type="submit" class="form-button">è¡¨ç¤º</button>
            </form>
        </div>
        `,

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæˆå½¢ãªã©ï¼‰
        utils: {
            escape: (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])),

            // pubkeyã‹ã‚‰ãƒªãƒ³ã‚¯ä»˜ãã®åå‰ï¼ˆã¾ãŸã¯npubã®ä¸€éƒ¨ï¼‰ã‚’è¿”ã™
            getNameLink: (pubkey, profile = {}) => {
                const name = profile.display_name || profile.name || "";
                const npub = NostrTools.nip19.npubEncode(pubkey);
                const displayName = name ? Components.utils.escape(name) : `${npub.substring(0, 10)}...`;
                // ã‚¯ãƒªãƒƒã‚¯ã§ ?id=npub... ã¸ç§»å‹•
                return `<a href="?id=${npub}" class="user-link" style="text-decoration: none; color: inherit; font-weight: bold;">${displayName}</a>`;
            },

            // æŠ•ç¨¿æœ¬æ–‡ã‚’ãƒªãƒƒãƒã«ã™ã‚‹ï¼ˆç”»åƒå±•é–‹ãƒ»ãƒªãƒ³ã‚¯åŒ–ï¼‰
            formatContent: async (content, tags) => {
                // 1. ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¨æ”¹è¡Œå‡¦ç†
                let html = Components.utils.escape(content).replace(/\n/g, '<br>');

                // 2. URLã®å‡¦ç†ï¼ˆç”»åƒå±•é–‹ or å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼‰
                const urlRegex = /\b(https?:\/\/[^\s]+)/g;
                html = html.replace(urlRegex, (url) => {
                    if (/\.(png|jpe?g|gif|webp|svg)$/i.test(url)) {
                        return `<img src="${url}" class="post-image" onclick="openModal('${url}')" style="max-width:100%; border-radius:8px; margin: 10px 0; cursor:pointer;">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
                });

                // 3. Nostr ID (nostr:...) ã®å‡¦ç†
                const nostrRegex = /nostr:(n(?:pub|event|ote|profile|addr)1[a-z0-9]+)/g;
                html = html.replace(nostrRegex, (match, nip19Id) => {
                    return `
                    <div class="quote-placeholder" data-id="${nip19Id}">
                    <a href="?id=${nip19Id}" class="nostr-link">nostr:${nip19Id.substring(0, 12)}...</a>
                    </div>`;
                });

                // 4. ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ç½®æ›
                tags.filter(t => t[0] === 'emoji').forEach(([_, code, url]) => {
                    const reg = new RegExp(`:${code}:`, 'g');
                    html = html.replace(reg, `<img src="${url}" class="custom-emoji" title=":${code}:" style="height: 1.2em; vertical-align: middle;">`);
                });

                return html;
            }            
        },

        reactionSection: (reactions) => {
            if (reactions.length === 0) return '';
            return `<div class="reactions-summary">ğŸŒŸ ${reactions.length} reactions</div>`;
        },

        replyCard: (event, contentHtml) => {
            return `
            <div class="reply-card">
                <div class="reply-content">${contentHtml}</div>
            </div>
        `;
        },
        
        quoteCard: (eventId, contentHtml = "èª­ã¿è¾¼ã¿ä¸­...", profile = {}) => {
            const nameHtml = profile.pubkey ? Components.utils.getNameLink(profile.pubkey, profile) : (profile.name || "...");
            return `
        <div id="quote-${eventId}" class="quote-card" ...>
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                <img src="${profile.picture || ''}" ...>
                <span style="font-weight: bold;">${nameHtml}</span>
            </div>
            <div class="quote-content">${contentHtml}</div>
        </div>
        `;
        }
    };

    // --- 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç† ---
    function setupEventListeners() {
        // ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³
        const backBtns = [document.getElementById('btn-back'), document.getElementById('btn-back-footer')];
        backBtns.forEach(btn => {
            btn?.addEventListener('click', () => {
                window.history.length > 1 ? window.history.back() : window.location.href = './';
            });
        });

        // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
        document.getElementById('btn-share')?.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
        });

        // èªè¨¼ãƒœã‚¿ãƒ³ (å¤–éƒ¨ã® auth-ui.js ã‚’å‘¼ã³å‡ºã™æƒ³å®š)
        document.getElementById('btn-auth')?.addEventListener('click', () => {
            if (typeof showAuthUI === 'function') showAuthUI();
        });
    }

    // --- 4. Workflow (ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‹ã‚‰è¡¨ç¤ºã¾ã§ã®æ‰‹é †) ---

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã®æµã‚Œ
        async function startProfileWorkflow(decoded) {
            showStatus('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...');

            // npubã¾ãŸã¯nprofileã‹ã‚‰å…¬é–‹éµã‚’å–å¾—
            const pubkey = decoded.data.pubkey || decoded.data.id || decoded.data;

            // ãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆã®æ±ºå®šï¼ˆIDã«ç´ã¥ããƒªãƒ¬ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallbackï¼‰
            const relays = (decoded.data.relays && decoded.data.relays.length > 0)
                ? decoded.data.relays
                : FALLBACK_RELAYS;

            try {
                // 1. ãƒªãƒ¬ãƒ¼ã«æ¥ç¶š
                await relayManager.connect(relays[0]);

                // 2. è³¼èª­é–‹å§‹ (subId, filters, handler)
                // relay-manager.js ã®ä»•æ§˜é€šã‚Šã€3ã¤ã®å¼•æ•°ã‚’æ¸¡ã—ã¾ã™
                relayManager.subscribe(
                    'profile-query',           // subId
                    {                          // filters
                        kinds: [0],
                        authors: [pubkey],
                        limit: 1
                    },
                    (type, event) => {         // handler (ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                        if (type === 'EVENT' && event) {
                            try {
                                const profile = JSON.parse(event.content);
                                const npub = NostrTools.nip19.npubEncode(pubkey);

                                // 3. æç”»
                                const renderArea = document.getElementById('render-area');
                                renderArea.innerHTML = Components.profileCard(profile, npub);

                                showStatus(''); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆã™

                                // 4. ç”¨ãŒæ¸ˆã‚“ã ã‚‰è³¼èª­è§£é™¤
                                relayManager.unsubscribe('profile-query');
                            } catch (e) {
                                console.error("Profile parse error:", e);
                            }
                        }
                    }
                );

            } catch (err) {
                console.error("Connection error:", err);
                showStatus('ãƒªãƒ¬ãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

    // --- 1. ã¾ãšã‚¤ãƒ™ãƒ³ãƒˆã‚’1ã¤ã ã‘å–ã£ã¦ãã‚‹é–¢æ•° ---
    async function fetchSingleEvent(decoded) {
        const eventId = typeof decoded === 'string' ? decoded : (decoded.data?.id || decoded.data);
        if (!eventId) return null;

        // æ¥ç¶šå…ˆã‚’å¢—ã‚„ã™ï¼ˆIDæŒ‡å®šãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallbackå…¨éƒ¨ï¼‰
        let relays = FALLBACK_RELAYS;
        if (typeof decoded === 'object' && decoded.data?.relays?.length > 0) {
            relays = Array.from(new Set([...decoded.data.relays, ...FALLBACK_RELAYS]));
        }

        console.log(`ğŸ“¡ è¤‡æ•°ãƒªãƒ¬ãƒ¼ã§ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢ä¸­: ${eventId.substring(0, 8)}`, relays);

        return new Promise((resolve) => {
            let isResolved = false;
            const subId = `fetch-once-${eventId.substring(0, 8)}`;

            // 8ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            const timer = setTimeout(() => {
                if (!isResolved) {
                    isResolved = true;
                    relays.forEach(url => window.relayManager.unsubscribe(subId));
                    resolve(null);
                }
            }, 8000);

            // æŒ‡å®šã—ãŸã™ã¹ã¦ã®ãƒªãƒ¬ãƒ¼ã«ä¸¦åˆ—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            relays.forEach(async (url) => {
                try {
                    await window.relayManager.connect(url);
                    window.relayManager.subscribe(subId, { ids: [eventId], limit: 1 }, (type, event) => {
                        if (type === 'EVENT' && event && !isResolved) {
                            isResolved = true;
                            clearTimeout(timer);

                            // å…¨ãƒªãƒ¬ãƒ¼ã®è³¼èª­ã‚’è§£é™¤
                            relays.forEach(u => window.relayManager.unsubscribe(subId));

                            window.dataStore.addEvent(event);
                            console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¦‹ (${url}): ${eventId.substring(0, 8)}`);
                            resolve(event);
                        }
                    });
                } catch (e) {
                    console.warn(`Connection failed for ${url}`);
                }
            });
        });
    }

    // --- 2. æŒ¯ã‚Šåˆ†ã‘ã‚’è¡Œã†ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ---
    async function startEventWorkflow(decoded) {
        const eventId = decoded.data.id || decoded.data;

        // ã™ã§ã« dataStore ã«ãã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹ãªã‚‰ã€ãƒªãƒ¬ãƒ¼ã«èãã«è¡Œã‹ãªã„
        const existingEvent = window.dataStore.getEvent(eventId);

        let event;
        if (existingEvent) {
            event = existingEvent;
            console.log("ğŸ“¦ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™");
        } else {
            showStatus('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
            event = await fetchSingleEvent(decoded);
        }

        if (!event) {
            showStatus('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            const renderArea = document.getElementById('render-area');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // ã“ã“ã§ Kind ã”ã¨ã®å‡¦ç†ã«åˆ†å²ï¼
        console.log(`ğŸ“¡ Event Kind: ${event.kind} ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ`);

        switch (event.kind) {
            case 1:
            case 30023:
                await renderStandardPost(event);
                break;
            case 6:
                // ãƒªãƒã‚¹ãƒˆã‚‚åŸºæœ¬ã¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ä¼¼ãŸã€Œå¯¾è±¡è¡¨ç¤ºã€ãŒå¿…è¦ã«ãªã‚Šã¾ã™
                renderGenericEvent(event, "ãƒªãƒã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ");
                break;
            case 7:
                await renderReactionEvent(event);
                break;
            case 40:
            case 41:
                ChannelHandlers.renderMetadata(event);
                break;
            case 42:
                await ChannelHandlers.renderMessage(event);
                break;
            default:
                renderGenericEvent(event);
                break;
        }

        showStatus(''); // èª­ã¿è¾¼ã¿å®Œäº†
    }

    /**
     * Kind 1 ã‚„ 30023 ãªã©ã®æ¨™æº–çš„ãªæŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    async function renderStandardPost(event) {
        const renderArea = document.getElementById('render-area');
        const profile = window.dataStore.getProfile(event.pubkey);

        // 1. æœ¬æ–‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆHTMLåŒ–ï¼‰
        const contentHtml = await Components.utils.formatContent(event.content, event.tags);

        // 2. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’æç”»
        renderArea.innerHTML = Components.eventBody(event, contentHtml, profile || {});

        // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°å–å¾—ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if (!profile) {
            window.profileFetcher.request(event.pubkey);
        }

        // 4. æœ¬æ–‡ã®ä¸­ã®ã€Œå¼•ç”¨ (nostr:...)ã€ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å±•é–‹
        if (typeof QuoteManager !== 'undefined') {
            QuoteManager.scanAndRender();
        }

        // 5. ä¸‹éƒ¨ã®ãƒªãƒ—ãƒ©ã‚¤ã‚„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—é–‹å§‹
        // IDã«ç´ã¥ããƒªãƒ¬ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallback
        const relays = FALLBACK_RELAYS;
        fetchRelatedData(event.id, relays);
    }

    // --- é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒªãƒ—ãƒ©ã‚¤ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã®å–å¾— ---
    async function fetchRelatedData(eventId, relays) {
        const reactionsList = document.getElementById('reactions-list');
        const relatedList = document.getElementById('related-events-list');
        const subContent = document.getElementById('sub-content');

        relayManager.subscribe('related-data', { '#e': [eventId], kinds: [1, 7] }, async (type, event) => {
            if (type === 'EVENT' && event) {
                window.dataStore.addEvent(event);
                subContent.classList.remove('hidden');

                if (event.kind === 7) {
                    // --- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é›†è¨ˆæç”» ---
                    // 1. ã“ã®æŠ•ç¨¿ã«å¯¾ã™ã‚‹å…¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒˆã‚¢ã‹ã‚‰å–å¾—
                    const allReactions = window.dataStore.getEventsByKind(7).filter(e =>
                        e.tags.some(t => t[0] === 'e' && t[1] === eventId)
                    );

                    // 2. çµµæ–‡å­—ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const reactionGroups = new Map();
                    allReactions.forEach(r => {
                        const emoji = r.content.trim() || '+';
                        if (!reactionGroups.has(emoji)) {
                            reactionGroups.set(emoji, { pubkeys: new Set(), event: r });
                        }
                        reactionGroups.get(emoji).pubkeys.add(r.pubkey);
                    });

                    // 3. HTMLçµ„ã¿ç«‹ã¦
                    let html = '';
                    for (const [emoji, group] of reactionGroups.entries()) {
                        // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—å¯¾å¿œï¼ˆformatContentã‚’åˆ©ç”¨ï¼‰
                        const emojiHtml = await Components.utils.formatContent(emoji === '+' ? 'â­' : emoji, group.event.tags);

                        // ã‚¢ãƒã‚¿ãƒ¼ã®ãƒªã‚¹ãƒˆä½œæˆ
                        const avatarsHtml = Array.from(group.pubkeys).map(pubkey => {
                            const profile = window.dataStore.getProfile(pubkey) || {};
                            const pic = profile.picture || 'https://ompomz.github.io/favicon.ico';
                            const npub = NostrTools.nip19.npubEncode(pubkey);

                            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°å–å¾—äºˆç´„
                            if (!window.dataStore.getProfile(pubkey)) {
                                window.profileFetcher.request(pubkey);
                            }

                            return `<a href="?id=${npub}"><img src="${pic}" class="reaction-avatar" title="${profile.name || ''}" style="width:20px; height:20px; border-radius:50%; margin-left:-5px; border:1px solid white;"></a>`;
                        }).join('');

                        html += `
                        <div class="reaction-group" style="display:inline-flex; align-items:center; background:#f0f0f0; padding:2px 8px; border-radius:15px; margin:2px; font-size:0.9rem;">
                            <span class="reaction-emoji">${emojiHtml}</span>
                            <div class="reaction-avatars" style="margin-left:5px; display:flex;">${avatarsHtml}</div>
                            <span style="margin-left:4px; font-size:0.7rem; color:#666;">${group.pubkeys.size}</span>
                        </div>`;
                    }
                    reactionsList.innerHTML = html;

                } else if (event.kind === 1) {
                    // ãƒªãƒ—ãƒ©ã‚¤ã®è¿½åŠ ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
                    const html = await Components.utils.formatContent(event.content, event.tags);
                    relatedList.innerHTML += Components.replyCard(event, html);
                }
            }
        });
    }

    /**
     * Kind 7 (ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³) ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    async function renderReactionEvent(event) {
        const renderArea = document.getElementById('render-area');

        // 1. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ï¼ˆé€šå¸¸ã¯ "+" ã‚„ "â­"ã€ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ãªã‚‰ :name:ï¼‰
        const emoji = event.content === "" ? "â­" : event.content;

        // 2. å¯¾è±¡ã¨ãªã‚‹ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆeã‚¿ã‚°ï¼‰ã‚’æ¢ã™
        const targetEventId = event.tags.find(t => t[0] === 'e')?.[1];

        // 3. æœ¬æ–‡ã®æ•´å½¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—å¯¾å¿œã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’é€šã™ï¼‰
        const emojiHtml = await Components.utils.formatContent(emoji, event.tags);
        const profile = window.dataStore.getProfile(event.pubkey);

        // â˜…åå‰ãƒªãƒ³ã‚¯ã®ç”Ÿæˆ
        const nameHtml = (typeof Components.utils.getNameLink === 'function') 
            ? Components.utils.getNameLink(event.pubkey, profile)
            : (() => {
                const name = profile?.display_name || profile?.name || event.pubkey.substring(0, 8);
                const npub = NostrTools.nip19.npubEncode(event.pubkey);
                return `<a href="?id=${npub}" style="text-decoration: none; color: inherit; font-weight: bold;">${Components.utils.escape(name)}</a>`;
            })();

        renderArea.innerHTML = `
        <div class="reaction-container" style="background: #fff5f8; border: 1px dashed #ffb3c1; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 2rem;">${emojiHtml}</span>
                <span>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã¾ã—ãŸ</span>
            </div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                By: ${nameHtml}
            </div>
        </div>
        <div id="reaction-target-root">
            <p style="color: #888; font-size: 0.8rem;">å¯¾è±¡ã®æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    `;

        // 4. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°å–å¾—
        if (!profile) {
            window.profileFetcher.request(event.pubkey);
        }

        // 5. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œå¯¾è±¡ã€ã¨ãªã£ãŸæŠ•ç¨¿ã‚’ä¸‹ã«è¡¨ç¤ºã™ã‚‹
        if (targetEventId) {
            renderTargetEvent(targetEventId);
        }
    }

    // è£œåŠ©é–¢æ•°ï¼šå¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    async function renderTargetEvent(eventId) {
        const targetRoot = document.getElementById('reaction-target-root');

        // ã™ã§ã« dataStore ã«ã‚ã‚‹ã‹ç¢ºèªï¼ˆç„¡é§„ãªé€šä¿¡ã‚’é˜²ãï¼‰
        let targetEvent = window.dataStore.getEvent(eventId);

        if (!targetEvent) {
            // dataStoreã«ç„¡ã„å ´åˆã®ã¿ãƒªãƒ¬ãƒ¼ã«èãã«è¡Œã
            targetEvent = await fetchSingleEvent(eventId);
        }

        if (targetEvent) {
            // ... (ã“ã“ã‹ã‚‰ä¸‹ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»Šã®ã¾ã¾ã§OKã§ã™) ...
            const contentHtml = await Components.utils.formatContent(targetEvent.content, targetEvent.tags);
            const profile = window.dataStore.getProfile(targetEvent.pubkey);

            targetRoot.innerHTML = `
            <div style="margin-bottom: 10px; font-size: 0.8rem; color: #888; margin-top:20px;">ğŸ‘‡ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å…ƒ</div>
            ${Components.eventBody(targetEvent, contentHtml, profile || {})}
        `;

            if (!profile) {
                window.profileFetcher.request(targetEvent.pubkey);
            }

            // å¼•ç”¨å±•é–‹
            if (typeof QuoteManager !== 'undefined') {
                QuoteManager.scanAndRender();
            }
        } else {
            targetRoot.innerHTML = `<p style="color: #ccc; padding: 20px;">å¯¾è±¡ã®æŠ•ç¨¿ï¼ˆ${eventId.substring(0, 8)}ï¼‰ã‚’ãƒªãƒ¬ãƒ¼ã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>`;
        }
    }

    function renderGenericEvent(event, message = "ä¸æ˜ãªã‚¤ãƒ™ãƒ³ãƒˆ") {
        const renderArea = document.getElementById('render-area');
        renderArea.innerHTML = `
        <div style="padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
            <h3>${message} (Kind: ${event.kind})</h3>
            <pre style="background: #eee; padding: 10px; overflow-x: auto;">${JSON.stringify(event, null, 2)}</pre>
        </div>
    `;
    }

    // --- 5. å®Ÿè¡Œï¼ˆã“ã“ãŒã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰ ---
    document.addEventListener('DOMContentLoaded', () => {
        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setupEventListeners();

        // URLã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æç”»ã‚’é–‹å§‹ã™ã‚‹
        initializeApp();
    });

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå±Šã„ãŸã‚‰ã€ä»Šã®ç”»é¢ã‚’ã‚‚ã†ä¸€åº¦æç”»ã—ç›´ã™
    document.addEventListener('profiles_updated', () => {
        console.log("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚’æ¤œçŸ¥ã€‚ç”»é¢ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚");
        // URLã®IDã‹ã‚‰ä»Šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†æç”»ã™ã‚‹
        initializeApp(); 
    });

</script>

</body>
</html>