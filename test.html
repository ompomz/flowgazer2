<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweetviewer</title>
<style>
/* --- Base / Layout --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.5; background-color: #f7f7f7; color: #666; font-size: 0.9rem; padding: 0.5rem; }
.container { max-width: 600px; margin: 0 ; padding: 0.5rem; }
.header-section, .footer-section { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px dashed #ddd; }
.footer-section { border-bottom: none; border-top: 1px dashed #ddd; }
.hidden { display: none; }

/* --- Components (Buttons/Forms) --- */
button { border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: 0.3s; }
button:hover { background-color: #ffa347; }
.form-input { flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; min-width: 0; }
.nostr-form { display: flex; align-items: center; gap: 0.5rem; padding-top: 0.25rem; }

/* --- Post / Profile --- */
.post-header { display: flex; align-items: center; gap: 10px; }
.post-content { margin: 0.5rem 0; line-height: 1.5; overflow-wrap: break-word; word-break: break-all; }
.post-footer { font-size: 0.8rem; color: #888; }
.profile-card { display: flex; flex-direction: column; gap: 1rem; padding: 1rem; background: #fff; border-radius: 8px; border: 1px solid #ddd; }
.profile-picture { width: 6rem; height: 6rem; border-radius: 50%; object-fit: cover; border: 3px solid rgba(0, 121, 107, 0.5); }
.header-pic { width: 4rem; height: 4rem; border-radius: 50%; object-fit: cover; border: 3px solid rgba(0, 121, 107, 0.5); }
.user-link { text-decoration: none; color: inherit; font-weight: bold; }
.user-link:hover { text-decoration: underline; color: #66b3ff; }

/* --- Reactions --- */
.reactions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.25rem 0 0.75rem 0; }
.reaction-group { display: inline-flex; align-items: center; background: #f8f8f8; padding: 2px 8px; border-radius: 15px; margin: 0.5rem 0rem 0rem 0rem; font-size: 0.9rem; border: 1px solid #eee; }
.reaction-avatars { margin-left: 8px; display: flex; align-items: center; flex-direction: row-reverse; }
.reaction-avatar { width: 20px; height: 20px; border-radius: 50%; margin-left: -5px; border: 1px solid white; background: #eee; object-fit: cover; }
.reaction-container { background: #fff5f8; border: 1px dashed #ffb3c1; border-radius: 12px; padding: 15px; margin-bottom: 20px; }

/* --- Media / Custom Emoji --- */
.video-container { margin: 10px 0; }
.video-container.youtube { aspect-ratio: 16 / 9; }
.video-container iframe, .video-container video { width: 100%; height: 100%; border-radius: 12px; border: none; }
.video-container video { max-width: 100%; height: auto; border: 1px solid #eee; }
.image-container { margin: 8px 0; }
.post-image { max-width: 15rem; max-height: 15rem; border-radius: 12px; border: 1px solid #eee; display: block; cursor: zoom-in; }
.custom-emoji { height: 1.2em; vertical-align: middle; display: inline-block; }

/* --- Modal (ç”»åƒæ‹¡å¤§) --- */
.modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.modal-content { margin: auto; display: block; max-width: 80%; max-height: 80vh; width: 80%; }
.modal-image { width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
.close-button { color: #fff; font-size: 40px; font-weight: 700; cursor: pointer; transition: 0.3s; }
.close-button:hover, .close-button:focus { color: #eee; text-decoration: none; cursor: pointer; }
</style>
</head>
<body>
<div id="modal-placeholder"></div>

<div class="container">
    <div id="nav-section" class="header-section">
        <button id="btn-back">ã‚‚ã©ã‚‹</button>
        <button id="btn-share">ã‚·ã‚§ã‚¢</button>
        <button id="btn-auth" class="auth-button">éµã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰</button>
    </div>
    <div style="margin: 0.5rem 0rem;">
    <main id="main-content">
        <div id="loading-status" class="hidden"></div>
        <div id="render-area"></div>
    </main>

    <section id="sub-content" class="hidden">
        <div id="reactions-section">
            <div id="reactions-list"></div>
        </div>
        <div id="related-events-section">
            <div id="related-events-list"></div>
        </div>
    </section>
    </div>
    <div id="footer-section" class="footer-section">
        <button id="btn-back-footer">ã‚‚ã©ã‚‹</button>
        <button id="save-list-btn" style="display:none;">ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¿å­˜</button>
    </div>
</div>

<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth-ui.js"></script>
<script src="https://ompomz.github.io/flowgazer/relay-manager.js"></script>
<script src="https://ompomz.github.io/flowgazer/data-store.js"></script>
<script src="https://ompomz.github.io/flowgazer/profile-fetcher.js"></script>
<script src="https://ompomz.github.io/flowgazer/app.js"></script>
<script src="./channel.js"></script>
<script src="./quote-manager.js"></script>

<script>
    function parseNevent(input) {
        try {
            const decoded = window.NostrTools.nip19.decode(input);
            const type = decoded.type; // 'npub', 'nevent', 'note' ãªã©
            const data = decoded.data;

            if (type === 'npub') {
                return { id: data, type: 'npub' }; // pubkeyã‚’idã¨ã—ã¦è¿”ã™
            }
            if (type === 'nevent') {
                return { id: data.id, type: 'nevent', relays: data.relays || [] };
            }
            if (type === 'note') {
                return { id: data, type: 'note' };
            }
            if (type === 'nprofile') {
                return { id: data.pubkey, type: 'nprofile', relays: data.relays || [] };
            }
            return null;
        } catch (e) {
            console.error("NIP-19 Decode Error:", e);
            return null;
        }
    }
    
    const FALLBACK_RELAYS = [
        'wss://relay.damus.io/',
        'wss://nos.lol/',
        'wss://relay.nostr.band/'
    ];

    function getPriorityRelays(hintRelays) {
        const combined = new Set([...hintRelays, ...FALLBACK_RELAYS]);
        return Array.from(combined);
    }

    function setupFormListener() {
        const form = document.getElementById('nostr-form');
        if (!form) return;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('nostr-id-input').value.trim();
            if (input) {
                window.location.href = `?id=${input}`;
            }
        });
    }

    function showStatus(message) {
        const statusElement = document.getElementById('loading-status');
        if (!statusElement) return;

        statusElement.textContent = message;
        if (message) {
            statusElement.classList.remove('hidden');
        } else {
            statusElement.classList.add('hidden');
        }
    }

    // --- 1. IDåˆ¤åˆ¥ã¨ãƒ«ãƒ¼ãƒˆæŒ¯ã‚Šåˆ†ã‘ ---
    function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const renderArea = document.getElementById('render-area');

        // 1. IDãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        if (!id) {
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // 2. IDã®ç¨®é¡ã‚’åˆ¤å®šã—ã¦æŒ¯ã‚Šåˆ†ã‘
        try {
            const decoded = NostrTools.nip19.decode(id);

            switch (decoded.type) {
                case 'npub':
                case 'nprofile':
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startProfileWorkflow(decoded);
                    break;

                case 'note':
                case 'nevent':
                case 'naddr':
                    // æŠ•ç¨¿è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startEventWorkflow(decoded);
                    break;

                default:
                    showStatus('ã‚¨ãƒ©ãƒ¼: æœªå¯¾å¿œã®IDå½¢å¼ã§ã™ã€‚');
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
            }
        } catch (err) {
            showStatus('ã‚¨ãƒ©ãƒ¼: IDã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
        }
    }

    // --- 2. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (HTMLã‚’çµ„ã¿ç«‹ã¦ã‚‹å°‚é–€å®¶) ---
    const Components = {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        profileCard: (profile, npub) => {
            const picture = profile.picture || 'https://ompomz.github.io/favicon.ico';
            const name = profile.name || 'Unknown';
            const about = profile.about ? `<p class="about-text">${Components.utils.escape(profile.about).replace(/\n/g, '<br>')}</p>` : '';

            return `
            <div class="profile-card">
                <div class="profile-header">
                    <img src="${picture}" class="profile-picture">
                    <div class="profile-info">
                        <h2 class="profile-name">${name}</h2>
                        <code class="npub-text">${npub.substring(0, 12)}...</code>
                    </div>
                </div>
                ${about}
            </div>
        `;
        },

        // æŠ•ç¨¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰æœ¬ä½“ã®ç”Ÿæˆ
        eventBody: (event, contentHtml, profile = {}) => {
            const date = new Date(event.created_at * 1000).toLocaleString();
            const picture = profile.picture || 'https://ompomz.github.io/favicon.ico';
            const nameHtml = Components.utils.getNameLink(event.pubkey, profile);

            return `
        <div class="main-post">
        <div class="post-header">
            <img src="${picture}" class="header-pic">
            <div>
                <div class="user-name">${nameHtml}</div>
                <div class="profile-npub">@${NostrTools.nip19.npubEncode(event.pubkey).substring(0, 10)}...</div>
            </div>
        </div>
        <div class="post-content">${contentHtml}</div>
        <div class="post-footer"><span>${date}</span></div>
        </div>`;
        },

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ç”Ÿæˆ
        inputForm: () => `
        <div class="input-form-container">
            <p class="form-title">Nostr IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <form id="nostr-form" class="nostr-form">
                <input type="text" id="nostr-id-input" placeholder="nevent1..., npub1..." required class="form-input">
                <button type="submit" class="form-button">è¡¨ç¤º</button>
            </form>
        </div>
        `,

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæˆå½¢ãªã©ï¼‰
        utils: {
            escape: (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])),

            // pubkeyã‹ã‚‰ãƒªãƒ³ã‚¯ä»˜ãã®åå‰ï¼ˆã¾ãŸã¯npubã®ä¸€éƒ¨ï¼‰ã‚’è¿”ã™
            getNameLink: (pubkey, profile = {}) => {
                const name = profile.display_name || profile.name || "";
                const npub = NostrTools.nip19.npubEncode(pubkey);
                const displayName = name ? Components.utils.escape(name) : `${npub.substring(0, 10)}...`;
                // ã‚¯ãƒªãƒƒã‚¯ã§ ?id=npub... ã¸ç§»å‹•
                return `<a href="?id=${npub}" class="user-link" style="text-decoration: none; color: inherit; font-weight: bold;">${displayName}</a>`;
            },

            // æŠ•ç¨¿æœ¬æ–‡ã‚’ãƒªãƒƒãƒã«ã™ã‚‹ï¼ˆç”»åƒå±•é–‹ãƒ»ãƒªãƒ³ã‚¯åŒ–ï¼‰
            formatContent: async (content, tags) => {
                // 1. ã¾ãšãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                let html = Components.utils.escape(content);

                // 2. å…ˆã«æ”¹è¡Œã‚’ <br> ã«å¤‰æ›ï¼ˆã“ã‚Œã§æœ¬æ–‡ã®æ”¹è¡Œã¯OKï¼‰
                html = html.replace(/\n/g, '<br>');

                // 3. ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆç”»åƒãƒ»å‹•ç”»ãƒ»YouTubeï¼‰ã¨URLã®å‡¦ç†
                // ã“ã“ã§ç”Ÿæˆã™ã‚‹HTMLã«ã¯æ”¹è¡Œã‚’å…¥ã‚Œãªã„ã‚ˆã†ã«é€£çµã—ã¾ã™
                const urlRegex = /https?:\/\/[\w/:%#\$&\?\(\)~\.=\+\-]+/g;

                html = html.replace(urlRegex, (url) => {
                    // --- YouTube ---
                    const ytMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                    if (ytMatch) {
                        const videoId = ytMatch[1];
                        return `
                        <div class="video-container youtube">
                            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                        </div>
                        `;
                    }

                    // --- å‹•ç”» ---
                    if (/\.(mp4|webm|mov)(?:\?.*)?$/i.test(url)) {
                        return `
                        <div class="video-container">
                            <video src="${url}" controls></video>
                        </div>
                        `;
                    }

                    // --- ç”»åƒ ---
                    if (/\.(png|jpe?g|gif|webp|svg)(?:\?.*)?$/i.test(url)) {
                        return `
                        <div class="image-container">
                            <img src="${url}" class="post-image" onclick="openModal('${url}')" onerror="this.style.display='none';">
                        </div>
                        `;
                    }

                    // --- é€šå¸¸ãƒªãƒ³ã‚¯ ---
                    return `<a href="${url}" target="_blank" rel="noopener" class="external-link">${url}</a>`;
                });

                // 4. Nostr ID (nostr:...) ã®å‡¦ç†
                const nostrRegex = /nostr:(n(?:pub|event|ote|profile|addr)1[a-z0-9]+)/g;
                html = html.replace(nostrRegex, (match, nip19Id) => {
                    return `<div class="quote-placeholder" data-id="${nip19Id}"><a href="?id=${nip19Id}" class="nostr-link">nostr:${nip19Id.substring(0, 12)}...</a></div>`;
                });

                // 5. ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ç½®æ›
                tags.filter(t => t[0] === 'emoji').forEach(([_, code, url]) => {
                    const reg = new RegExp(`:${code}:`, 'g');
                    html = html.replace(reg, `<img src="${url}" class="custom-emoji" title=":${code}:">`);
                });

                return html;
            }
        },

        reactionSection: (reactions) => {
            if (reactions.length === 0) return '';
            return `<div class="reactions-summary">ğŸŒŸ ${reactions.length} reactions</div>`;
        },

        replyCard: (event, contentHtml) => {
            return `
            <div class="reply-card">
                <div class="reply-content">${contentHtml}</div>
            </div>
        `;
        },
        
        quoteCard: (eventId, contentHtml = "èª­ã¿è¾¼ã¿ä¸­...", profile = {}) => {
            const nameHtml = profile.pubkey ? Components.utils.getNameLink(profile.pubkey, profile) : (profile.name || "...");
            return `
        <div id="quote-${eventId}" class="quote-card" ...>
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                <img src="${profile.picture || ''}" ...>
                <span style="font-weight: bold;">${nameHtml}</span>
            </div>
            <div class="quote-content">${contentHtml}</div>
        </div>
        `;
        }
    };

    // --- 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç† ---
    function setupEventListeners() {
        // ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³
        const backBtns = [document.getElementById('btn-back'), document.getElementById('btn-back-footer')];
        backBtns.forEach(btn => {
            btn?.addEventListener('click', () => {
                window.history.length > 1 ? window.history.back() : window.location.href = './';
            });
        });

        // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
        document.getElementById('btn-share')?.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
        });

        // èªè¨¼ãƒœã‚¿ãƒ³ (å¤–éƒ¨ã® auth-ui.js ã‚’å‘¼ã³å‡ºã™æƒ³å®š)
        document.getElementById('btn-auth')?.addEventListener('click', () => {
            if (typeof showAuthUI === 'function') showAuthUI();
        });
    }

    // --- 4. Workflow (ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‹ã‚‰è¡¨ç¤ºã¾ã§ã®æ‰‹é †) ---

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã®æµã‚Œ
        async function startProfileWorkflow(decoded) {
            showStatus('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...');

            // npubã¾ãŸã¯nprofileã‹ã‚‰å…¬é–‹éµã‚’å–å¾—
            const pubkey = decoded.data.pubkey || decoded.data.id || decoded.data;

            // ãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆã®æ±ºå®šï¼ˆIDã«ç´ã¥ããƒªãƒ¬ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallbackï¼‰
            const relays = (decoded.data.relays && decoded.data.relays.length > 0)
                ? decoded.data.relays
                : FALLBACK_RELAYS;

            try {
                // 1. ãƒªãƒ¬ãƒ¼ã«æ¥ç¶š
                await relayManager.connect(relays[0]);

                // 2. è³¼èª­é–‹å§‹ (subId, filters, handler)
                // relay-manager.js ã®ä»•æ§˜é€šã‚Šã€3ã¤ã®å¼•æ•°ã‚’æ¸¡ã—ã¾ã™
                relayManager.subscribe(
                    'profile-query',           // subId
                    {                          // filters
                        kinds: [0],
                        authors: [pubkey],
                        limit: 1
                    },
                    (type, event) => {         // handler (ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                        if (type === 'EVENT' && event) {
                            try {
                                const profile = JSON.parse(event.content);
                                const npub = NostrTools.nip19.npubEncode(pubkey);

                                // 3. æç”»
                                const renderArea = document.getElementById('render-area');
                                renderArea.innerHTML = Components.profileCard(profile, npub);

                                showStatus(''); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆã™

                                // 4. ç”¨ãŒæ¸ˆã‚“ã ã‚‰è³¼èª­è§£é™¤
                                relayManager.unsubscribe('profile-query');
                            } catch (e) {
                                console.error("Profile parse error:", e);
                            }
                        }
                    }
                );

            } catch (err) {
                console.error("Connection error:", err);
                showStatus('ãƒªãƒ¬ãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

    // --- 1. ã¾ãšã‚¤ãƒ™ãƒ³ãƒˆã‚’1ã¤ã ã‘å–ã£ã¦ãã‚‹é–¢æ•° ---
    async function fetchSingleEvent(originalId) {
        const decoded = parseNevent(originalId);
        if (!decoded) return null;

        const { id, relays: hintRelays } = decoded;
        const targetRelays = getPriorityRelays(hintRelays || []);

        for (const url of targetRelays) {
            try {
                console.log(`[æ¢ç´¢é–‹å§‹] ${url} ã«æ¥ç¶šä¸­...`);
                const event = await window.relayManager.getEvent(url, { ids: [id] });

                if (event) {
                    console.log(`[ç™ºè¦‹ï¼] ${url} ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¦‹ã—ã¾ã—ãŸ`);
                    return { event, foundRelay: url };
                }
            } catch (error) {
                console.warn(`[ã‚¨ãƒ©ãƒ¼] ${url} ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
            }
        }
        return null;
    }

    // --- 2. æŒ¯ã‚Šåˆ†ã‘ã‚’è¡Œã†ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ---
    async function startEventWorkflow(originalId) {
        try {
            // 1. IDã®è§£æ
            const decoded = parseNevent(originalId);

            // è§£æã«å¤±æ•—ã—ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰
            if (!decoded || !decoded.id) {
                throw new Error("IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            }

            const renderArea = document.getElementById('render-area');

            // ==========================================
            // ã‚±ãƒ¼ã‚¹A: npub ã¾ãŸã¯ nprofile (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ä¸€è¦§è¡¨ç¤º)
            // ==========================================
            if (originalId.startsWith('npub') || originalId.startsWith('nprofile')) {
                const pubkey = decoded.id;
                showStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚’å–å¾—ä¸­...');

                // app.js ã®æ±ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦æŠ•ç¨¿ã‚’å–å¾—
                // window.app ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æ
                const posts = await window.app.fetchUserPosts(pubkey);

                if (posts && posts.length > 0) {
                    renderArea.innerHTML = ''; // ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢

                    for (const post of posts) {
                        // ç¬¬2å¼•æ•° true: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§æç”»
                        await renderStandardPost(post, true);
                    }
                    showStatus('');
                } else {
                    showStatus('æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', true);
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
                }
                return; // æŠ•ç¨¿ä¸€è¦§ã‚’å‡ºã—ãŸã‚‰ã“ã“ã§çµ‚äº†
            }

            // ==========================================
            // ã‚±ãƒ¼ã‚¹B: nevent / note (å˜ä¸€ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°è¡¨ç¤º)
            // ==========================================
            const eventId = decoded.id;
            const existingEvent = window.dataStore.getEvent(eventId);

            let result;

            // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ or ãƒªãƒ¬ãƒ¼ï¼‰
            if (existingEvent) {
                result = { event: existingEvent, foundRelay: null };
            } else {
                showStatus('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
                // fetchSingleEvent ã¯ nevent/note ç”¨ã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
                result = await fetchSingleEvent(originalId);
            }

            // çµæœã®å­˜åœ¨ç¢ºèª
            if (!result || !result.event) {
                showStatus('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', true);
                if (renderArea) {
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
                }
                return;
            }

            const { event, foundRelay } = result;
            console.log(`ğŸ“¡ Event Kind: ${event.kind} (Source: ${foundRelay || 'Cache'})`);

            // 3. Kind ã”ã¨ã®è¡¨ç¤ºå‡¦ç†ã«åˆ†å²
            switch (event.kind) {
                case 1:
                case 30023:
                    await renderStandardPost(event, false); // è©³ç´°è¡¨ç¤º
                    break;
                case 6:
                    if (typeof renderRepost === 'function') {
                        renderRepost(event);
                    } else {
                        renderGenericEvent(event, "ãƒªãƒã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ");
                    }
                    break;
                case 7:
                    await renderReactionEvent(event);
                    break;
                case 40:
                case 41:
                    ChannelHandlers.renderMetadata(event);
                    break;
                case 42:
                    await ChannelHandlers.renderMessage(event);
                    break;
                default:
                    renderGenericEvent(event);
                    break;
            }

            // 4. é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒªãƒ—ãƒ©ã‚¤ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã®å–å¾—
            const relaysForRelated = foundRelay
                ? [...new Set([foundRelay, ...FALLBACK_RELAYS])]
                : FALLBACK_RELAYS;

            fetchRelatedData(event.id, relaysForRelated);
            showStatus('');

        } catch (error) {
            console.error("Workflow Error:", error);
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);

            const renderArea = document.getElementById('render-area');
            if (renderArea) {
                renderArea.innerHTML = Components.inputForm();
                setupFormListener();
            }
        }
    }

    /**
     * Kind 1 ã‚„ 30023 ãªã©ã®æ¨™æº–çš„ãªæŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    async function renderStandardPost(event) {
        const renderArea = document.getElementById('render-area');
        const profile = window.dataStore.getProfile(event.pubkey);

        // 1. æœ¬æ–‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆHTMLåŒ–ï¼‰
        const contentHtml = await Components.utils.formatContent(event.content, event.tags);

        // 2. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’æç”»
        renderArea.innerHTML = Components.eventBody(event, contentHtml, profile || {});

        // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°å–å¾—ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if (!profile) {
            window.profileFetcher.request(event.pubkey);
        }

        // 4. æœ¬æ–‡ã®ä¸­ã®ã€Œå¼•ç”¨ (nostr:...)ã€ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å±•é–‹
        if (typeof QuoteManager !== 'undefined') {
            QuoteManager.scanAndRender();
        }

        // 5. ä¸‹éƒ¨ã®ãƒªãƒ—ãƒ©ã‚¤ã‚„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—é–‹å§‹
        // IDã«ç´ã¥ããƒªãƒ¬ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallback
        const relays = FALLBACK_RELAYS;
        fetchRelatedData(event.id, relays);
    }

    // --- é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒªãƒ—ãƒ©ã‚¤ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã®å–å¾— ---
    async function fetchRelatedData(eventId, relays) {
        const reactionsList = document.getElementById('reactions-list');
        const relatedList = document.getElementById('related-events-list');
        const subContent = document.getElementById('sub-content');

        // ãƒªãƒ—ãƒ©ã‚¤(1)ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³(7)ã‚’è³¼èª­
        relayManager.subscribe('related-data', { '#e': [eventId], kinds: [1, 7] }, async (type, event) => {
            if (type === 'EVENT' && event) {
                // 1. ã¾ãšã¯ DataStore ã«ä¿å­˜
                window.dataStore.addEvent(event);
                subContent.classList.remove('hidden');

                if (event.kind === 7) {
                    // --- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é›†è¨ˆã¨æç”» ---
                    // ã‚¹ãƒˆã‚¢ã«ã‚ã‚‹å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã€ã“ã®æŠ•ç¨¿(eventId)ã«å¯¾ã™ã‚‹Kind 7ã ã‘ã‚’æŠ½å‡º
                    const allReactions = Array.from(window.dataStore.events.values()).filter(e =>
                        e.kind === 7 && e.tags.some(t => t[0] === 'e' && t[1] === eventId)
                    );

                    // çµµæ–‡å­—ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const reactionGroups = new Map();
                    allReactions.forEach(r => {
                        const emoji = r.content.trim() || '+';
                        if (!reactionGroups.has(emoji)) {
                            reactionGroups.set(emoji, { pubkeys: new Set(), event: r });
                        }
                        reactionGroups.get(emoji).pubkeys.add(r.pubkey);
                    });

                    // HTMLçµ„ã¿ç«‹ã¦
                    let html = '';
                    for (const [emoji, group] of reactionGroups.entries()) {
                        // ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—å¯¾å¿œï¼ˆformatContentã‚’åˆ©ç”¨ï¼‰
                        const emojiHtml = await Components.utils.formatContent(emoji === '+' ? 'â­' : emoji, group.event.tags);

                        // ã‚¢ãƒã‚¿ãƒ¼ã®ãƒªã‚¹ãƒˆä½œæˆ
                        const avatarsHtml = Array.from(group.pubkeys).map(pubkey => {
                            const profile = window.dataStore.getProfile(pubkey) || {};
                            const pic = profile.picture || 'https://ompomz.github.io/favicon.ico';
                            const npub = NostrTools.nip19.npubEncode(pubkey);
                            return `
                            <a href="?id=${npub}">
                            <img src="${pic}" class="reaction-avatar" title="${profile.name || ''}">
                            </a>`;
                        }).join('');

                        html += `
                        <div class="reaction-group">
                        <span class="reaction-emoji">${emojiHtml}</span>
                        <div class="reaction-avatars">${avatarsHtml}</div>
                        </div>`;
                    }
                    reactionsList.innerHTML = html;

                } else if (event.kind === 1) {
                    // ãƒªãƒ—ãƒ©ã‚¤ã®è¿½åŠ 
                    const html = await Components.utils.formatContent(event.content, event.tags);
                    const profile = window.dataStore.getProfile(event.pubkey) || {};

                    // ãƒªãƒ—ãƒ©ã‚¤ã«ã‚‚åå‰ãƒªãƒ³ã‚¯ã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…¥ã‚Œã‚‹ãªã‚‰ã“ã“ã‚’ Components.replyCard ã«æ¸¡ã™
                    relatedList.innerHTML += Components.replyCard(event, html);

                    if (!window.dataStore.getProfile(event.pubkey)) {
                        window.profileFetcher.request(event.pubkey);
                    }
                }
            }
        });
    }

    /**
     * Kind 7 (ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³) ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    async function renderReactionEvent(event) {
        const renderArea = document.getElementById('render-area');

        // 1. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ï¼ˆé€šå¸¸ã¯ "+" ã‚„ "â­"ã€ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ãªã‚‰ :name:ï¼‰
        const emoji = event.content === "" ? "â­" : event.content;

        // 2. å¯¾è±¡ã¨ãªã‚‹ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆeã‚¿ã‚°ï¼‰ã‚’æ¢ã™
        const targetEventId = event.tags.find(t => t[0] === 'e')?.[1];

        // 3. æœ¬æ–‡ã®æ•´å½¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—å¯¾å¿œã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’é€šã™ï¼‰
        const emojiHtml = await Components.utils.formatContent(emoji, event.tags);
        const profile = window.dataStore.getProfile(event.pubkey);

        // â˜…åå‰ãƒªãƒ³ã‚¯ã®ç”Ÿæˆ
        const nameHtml = (typeof Components.utils.getNameLink === 'function') 
            ? Components.utils.getNameLink(event.pubkey, profile)
            : (() => {
                const name = profile?.display_name || profile?.name || event.pubkey.substring(0, 8);
                const npub = NostrTools.nip19.npubEncode(event.pubkey);
                return `<a href="?id=${npub}" style="text-decoration: none; color: inherit; font-weight: bold;">${Components.utils.escape(name)}</a>`;
            })();

        renderArea.innerHTML = `
        <div class="reaction-container">
        <div style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 2rem;">${emojiHtml}</span>
            <span>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã¾ã—ãŸ</span>
        </div>
        <div class="post-footer" style="color:#666">By: ${nameHtml}</div>
        </div>
        <div id="reaction-target-root">
        <p style="color: #888; font-size: 0.8rem;">å¯¾è±¡ã®æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>`;

        // 4. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°å–å¾—
        if (!profile) {
            window.profileFetcher.request(event.pubkey);
        }

        // 5. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œå¯¾è±¡ã€ã¨ãªã£ãŸæŠ•ç¨¿ã‚’ä¸‹ã«è¡¨ç¤ºã™ã‚‹
        if (targetEventId) {
            renderTargetEvent(targetEventId);
        }
    }

    // è£œåŠ©é–¢æ•°ï¼šå¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    async function renderTargetEvent(eventId) {
        const targetRoot = document.getElementById('reaction-target-root');

        // ã™ã§ã« dataStore ã«ã‚ã‚‹ã‹ç¢ºèªï¼ˆç„¡é§„ãªé€šä¿¡ã‚’é˜²ãï¼‰
        let targetEvent = window.dataStore.getEvent(eventId);

        if (!targetEvent) {
            // dataStoreã«ç„¡ã„å ´åˆã®ã¿ãƒªãƒ¬ãƒ¼ã«èãã«è¡Œã
            targetEvent = await fetchSingleEvent(eventId);
        }

        if (targetEvent) {
            // ... (ã“ã“ã‹ã‚‰ä¸‹ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»Šã®ã¾ã¾ã§OKã§ã™) ...
            const contentHtml = await Components.utils.formatContent(targetEvent.content, targetEvent.tags);
            const profile = window.dataStore.getProfile(targetEvent.pubkey);

            targetRoot.innerHTML = `
            <div style="margin-bottom: 10px; font-size: 0.8rem; color: #888; margin-top:20px;">ğŸ‘‡ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å…ƒ</div>
            ${Components.eventBody(targetEvent, contentHtml, profile || {})}
        `;

            if (!profile) {
                window.profileFetcher.request(targetEvent.pubkey);
            }

            // å¼•ç”¨å±•é–‹
            if (typeof QuoteManager !== 'undefined') {
                QuoteManager.scanAndRender();
            }
        } else {
            targetRoot.innerHTML = `<p style="color: #ccc; padding: 20px;">å¯¾è±¡ã®æŠ•ç¨¿ï¼ˆ${eventId.substring(0, 8)}ï¼‰ã‚’ãƒªãƒ¬ãƒ¼ã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>`;
        }
    }

    function renderGenericEvent(event, message = "ä¸æ˜ãªã‚¤ãƒ™ãƒ³ãƒˆ") {
        const renderArea = document.getElementById('render-area');
        renderArea.innerHTML = `
        <div style="padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
            <h3>${message} (Kind: ${event.kind})</h3>
            <pre style="background: #eee; padding: 10px; overflow-x: auto;">${JSON.stringify(event, null, 2)}</pre>
        </div>
    `;
    }

    // --- 5. å®Ÿè¡Œï¼ˆã“ã“ãŒã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰ ---
    document.addEventListener('DOMContentLoaded', () => {
        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setupEventListeners();

        // URLã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æç”»ã‚’é–‹å§‹ã™ã‚‹
        initializeApp();
    });

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå±Šã„ãŸã‚‰ã€ä»Šã®ç”»é¢ã‚’ã‚‚ã†ä¸€åº¦æç”»ã—ç›´ã™
    document.addEventListener('profiles_updated', () => {
        console.log("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚’æ¤œçŸ¥ã€‚ç”»é¢ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚");
        // URLã®IDã‹ã‚‰ä»Šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†æç”»ã™ã‚‹
        initializeApp(); 
    });
// æŠ•ç¨¿ã‚’æç”»ã™ã‚‹éš›ã€HTMLã«ä»¥ä¸‹ã®ã‚ˆã†ãªä»•æ›ã‘ã‚’å…¥ã‚Œã‚‹ã ã‘ï¼
// é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã¾ãŸã¯ãƒœã‚¿ãƒ³ï¼‰ã‹ã‚‰ã“ã‚Œã‚’å‘¼ã¶
window.sendLikeEvent(event.id, event.pubkey);

</script>

</body>
</html>
