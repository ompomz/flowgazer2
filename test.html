<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweetviewer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; line-height: 1.5; background-color: #f7f7f7; color: #666; font-size: 0.9rem; padding: 0.5rem; }
.container { max-width: 600px; margin: 0; padding: 0.5rem; border-radius: 4px; }
.container h1 { font-size: 1.3rem; }
.container h2 { font-size: 1.1rem; }
.container p { word-break: break-all; }
.container a { color: #66b3ff; text-decoration: none; }
.container a:hover { color: #4da6ff; text-decoration: underline; }
@media (max-width: 767px) { .container { max-width: 100%; } }
.container button { border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: background-color 0.3s ease, color 0.3s ease; }
.container button:hover { background-color: #ffa347; }
.header-section { display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px dashed #ddd; }
#main-event { padding: 0.5rem 0; }
#status { margin: 0.5rem 0rem; font-weight: bold; color: #ff99cc; }
.reactions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.25rem 0rem 0.75rem 0rem; }
.reactions-list img{ height: 1.25rem !important; object-fit: cover;}
.reaction-group { display: flex; align-items: center; background-color: #eee; border-radius: 999px; padding: 0.2rem 0.5rem; font-size: 0.8rem; }
.reaction-avatars { display: flex; flex-direction: row-reverse; }
.reaction-avatar { width: 1.25rem; height: 1.25rem; border-radius: 50%; object-fit: cover; display: block; margin: 0; }
.related-posts { margin: 0.5rem 0rem; }
.related-post-card { background-color: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem 0.5rem; margin: 0.5rem 0rem; }
.related-post-card .profile { display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0rem; }
.related-post-card .profile-name, .related-post-card .profile-npub { font-size: 0.8rem; }
.related-post-card .profile-image { width: 1.5rem; height: 1.5rem; }
.related-post-card .post-content { font-size: 0.8rem; margin: 0.5rem 0rem 0.75rem 0rem; }
.profile { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.profile-image { width: 2rem; height: 2rem; border-radius: 50%; object-fit: cover; }
.profile-name { font-weight: bold; font-size: 1rem; color: #444; }
.profile-nip05, .profile-npub { text-decoration: none !important; font-size: 0.8rem; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.profile-picture { width: 6rem; height: 6rem; border-radius: 50%; object-fit: cover; border: 3px solid rgba(0, 121, 107, 0.5); }
@media (max-width: 370px) { .profile-picture { width: 4.5rem; height: 4.5rem; } }
.profile-card { display: flex; flex-direction: column; gap: 1rem; padding: 1rem; background-color: #fff; border-radius: 8px; border: 1px solid #ddd; }
.profile-header { display: flex; align-items: center; gap: 1rem; }
.profile-info-container { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
.npub-container { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; word-break: break-all; padding: 0.25rem 0rem 0rem 0rem; }
.copy-icon { cursor: pointer; transition: opacity 0.2s ease; }
.copy-icon:hover { opacity: 0.4; }
.about-text { font-size: 0.9rem; line-height: 1.5; color: #333; word-break: break-all; }
.about-text a { color: #66b3ff; text-decoration: underline; }
.about-text a:hover { color: #4da6ff; }
.about-text .custom-emoji { height: 1.2rem; vertical-align: middle; }
.post-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #999; }
.post-content { margin: 0.5rem 0rem; line-height: 1.5; overflow-wrap: break-word; word-break: break-word; }
.post-content img { max-width: 15rem; max-height: 15rem; height: auto; display: block; margin: 0; }
.post-content img.custom-emoji { vertical-align: middle; display: inline-block; height: 1.2rem; }
.post-content ul, .post-content ol { list-style-position: inside; }
.nostr-form { display: flex; flex-direction: row; align-items: center; gap: 0.5rem; padding-top: 0.25rem; }
.form-input { flex: 1; min-width: 0; width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
.form-button { flex-shrink: 0; padding: 0.5rem 1.2rem !important; }
.footer-section { padding: 0.5rem 0; border-top: 1px dashed #ddd; }
.hidden { display: none; }
.modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.modal-content { margin: auto; display: block; max-width: 80%; max-height: 80vh; width: 80%; }
.modal-image { width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
.close-button { color: #fff; font-size: 40px; font-weight: 700; cursor: pointer; transition: 0.3s; }
.close-button:hover, .close-button:focus { color: #eee; text-decoration: none; cursor: pointer; }
.custom-emoji-hover:hover { transform: scale(2.0); z-index: 10; }
</style>
</head>
<body>
<div id="modal-placeholder"></div>

<div class="container">
    <div id="nav-section" class="header-section">
        <button id="btn-back">ã‚‚ã©ã‚‹</button>
        <button id="btn-share">ã‚·ã‚§ã‚¢</button>
        <button id="btn-auth" class="auth-button">éµã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰</button>
    </div>

    <main id="main-content">
        <div id="loading-status" class="hidden"></div>
        <div id="render-area"></div>
    </main>

    <section id="sub-content" class="hidden">
        <div id="reactions-section">
            <h3>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="reactions-list"></div>
        </div>
        <div id="related-events-section">
            <h3>é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
            <div id="related-events-list"></div>
        </div>
    </section>

    <div id="footer-section" class="footer-section">
        <button id="btn-back-footer">ã‚‚ã©ã‚‹</button>
        <button id="save-list-btn" style="display:none;">ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¿å­˜</button>
    </div>
</div>

<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer/auth-ui.js"></script>
<script src="https://ompomz.github.io/flowgazer/relay-manager.js"></script>
<script src="https://ompomz.github.io/flowgazer/data-store.js"></script>
<script src="https://ompomz.github.io/flowgazer/profile-fetcher.js"></script>

<script>

    const FALLBACK_RELAYS = [
        "wss://relay.damus.io/",
        "wss://nos.lol/",
        "wss://relay.nostr.band/"
    ];

    function setupFormListener() {
        const form = document.getElementById('nostr-form');
        if (!form) return;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('nostr-id-input').value.trim();
            if (input) {
                window.location.href = `?id=${input}`;
            }
        });
    }

    function showStatus(message) {
        const statusElement = document.getElementById('loading-status'); // HTMLå´ã®IDã«åˆã‚ã›ã¦ãã ã•ã„
        if (!statusElement) return;

        statusElement.textContent = message;
        if (message) {
            statusElement.classList.remove('hidden');
        } else {
            statusElement.classList.add('hidden');
        }
    }

    // --- 1. IDåˆ¤åˆ¥ã¨ãƒ«ãƒ¼ãƒˆæŒ¯ã‚Šåˆ†ã‘ ---
    function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const renderArea = document.getElementById('render-area');

        // 1. IDãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        if (!id) {
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // 2. IDã®ç¨®é¡ã‚’åˆ¤å®šã—ã¦æŒ¯ã‚Šåˆ†ã‘
        try {
            const decoded = NostrTools.nip19.decode(id);

            switch (decoded.type) {
                case 'npub':
                case 'nprofile':
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startProfileWorkflow(decoded);
                    break;

                case 'note':
                case 'nevent':
                case 'naddr':
                    // æŠ•ç¨¿è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
                    startEventWorkflow(decoded);
                    break;

                default:
                    showStatus('ã‚¨ãƒ©ãƒ¼: æœªå¯¾å¿œã®IDå½¢å¼ã§ã™ã€‚');
                    renderArea.innerHTML = Components.inputForm();
                    setupFormListener();
            }
        } catch (err) {
            showStatus('ã‚¨ãƒ©ãƒ¼: IDã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
        }
    }

    // --- 2. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (HTMLã‚’çµ„ã¿ç«‹ã¦ã‚‹å°‚é–€å®¶) ---
    const Components = {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        profileCard: (profile, npub) => {
            const picture = profile.picture || './favicon.ico';
            const name = profile.name || 'Unknown';
            const about = profile.about ? `<p class="about-text">${Components.utils.escape(profile.about).replace(/\n/g, '<br>')}</p>` : '';

            return `
            <div class="profile-card">
                <div class="profile-header">
                    <img src="${picture}" class="profile-picture">
                    <div class="profile-info">
                        <h2 class="profile-name">${name}</h2>
                        <code class="npub-text">${npub.substring(0, 12)}...</code>
                    </div>
                </div>
                ${about}
            </div>
        `;
        },

        // æŠ•ç¨¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰æœ¬ä½“ã®ç”Ÿæˆ
        eventBody: (event, contentHtml, profile = {}) => {
            const date = new Date(event.created_at * 1000).toLocaleString();
            const picture = profile.picture || './favicon.ico';
            const name = profile.display_name || profile.name || 'Unknown';

            return `
        <div class="main-post">
            <div class="post-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="${picture}" style="width: 48px; height: 48px; border-radius: 50%;">
                <div>
                    <div style="font-weight: bold;">${Components.utils.escape(name)}</div>
                    <div style="font-size: 0.8rem; color: #666;">@${NostrTools.nip19.npubEncode(event.pubkey).substring(0, 10)}...</div>
                </div>
            </div>
            <div class="post-content">${contentHtml}</div>
            <div class="post-footer" style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                <span>${date}</span>
            </div>
        </div>
        `;
        },

        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ç”Ÿæˆ
        inputForm: () => `
        <div class="input-form-container">
            <p class="form-title">Nostr IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <form id="nostr-form" class="nostr-form">
                <input type="text" id="nostr-id-input" placeholder="nevent1..., npub1..." required class="form-input">
                <button type="submit" class="form-button">è¡¨ç¤º</button>
            </form>
        </div>
        `,

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæˆå½¢ãªã©ï¼‰
        utils: {
            escape: (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])),

            // æŠ•ç¨¿æœ¬æ–‡ã‚’ãƒªãƒƒãƒã«ã™ã‚‹ï¼ˆç”»åƒå±•é–‹ãƒ»ãƒªãƒ³ã‚¯åŒ–ï¼‰
            formatContent: async (content, tags) => {
                // 1. ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¨æ”¹è¡Œå‡¦ç†
                let html = Components.utils.escape(content).replace(/\n/g, '<br>');

                // 2. URLã®å‡¦ç†ï¼ˆç”»åƒå±•é–‹ or å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼‰
                const urlRegex = /\b(https?:\/\/[^\s]+)/g;
                html = html.replace(urlRegex, (url) => {
                    if (/\.(png|jpe?g|gif|webp|svg)$/i.test(url)) {
                        return `<img src="${url}" class="post-image" onclick="openModal('${url}')" style="max-width:100%; border-radius:8px; margin: 10px 0; cursor:pointer;">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
                });

                // 3. Nostr ID (nostr:...) ã®å‡¦ç†
                const nostrRegex = /nostr:(n(?:pub|event|ote|profile|addr)1[a-z0-9]+)/g;
                html = html.replace(nostrRegex, (match, nip19Id) => {
                    return `
                    <div class="quote-placeholder" data-id="${nip19Id}">
                    <a href="?id=${nip19Id}" class="nostr-link">nostr:${nip19Id.substring(0, 12)}...</a>
                    </div>`;
                });

                // 4. ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã®ç½®æ›
                tags.filter(t => t[0] === 'emoji').forEach(([_, code, url]) => {
                    const reg = new RegExp(`:${code}:`, 'g');
                    html = html.replace(reg, `<img src="${url}" class="custom-emoji" title=":${code}:" style="height: 1.2em; vertical-align: middle;">`);
                });

                return html;
            }            
        },

        reactionSection: (reactions) => {
            if (reactions.length === 0) return '';
            return `<div class="reactions-summary">ğŸŒŸ ${reactions.length} reactions</div>`;
        },

        replyCard: (event, contentHtml) => {
            return `
            <div class="reply-card">
                <div class="reply-content">${contentHtml}</div>
            </div>
        `;
        },
        
        quoteCard: (eventId, contentHtml = "èª­ã¿è¾¼ã¿ä¸­...", profile = {}) => {
            const name = profile.display_name || profile.name || '...';
            return `
        <div id="quote-${eventId}" class="quote-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.9rem; background: #fafafa;">
            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                <img src="${profile.picture || ''}" style="width: 20px; height: 20px; border-radius: 50%; background: #eee;">
                <span style="font-weight: bold;">${Components.utils.escape(name)}</span>
            </div>
            <div class="quote-content">${contentHtml}</div>
        </div>
        `;
        }
    };

    // --- 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç† ---
    function setupEventListeners() {
        // ã‚‚ã©ã‚‹ãƒœã‚¿ãƒ³
        const backBtns = [document.getElementById('btn-back'), document.getElementById('btn-back-footer')];
        backBtns.forEach(btn => {
            btn?.addEventListener('click', () => {
                window.history.length > 1 ? window.history.back() : window.location.href = './';
            });
        });

        // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
        document.getElementById('btn-share')?.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
        });

        // èªè¨¼ãƒœã‚¿ãƒ³ (å¤–éƒ¨ã® auth-ui.js ã‚’å‘¼ã³å‡ºã™æƒ³å®š)
        document.getElementById('btn-auth')?.addEventListener('click', () => {
            if (typeof showAuthUI === 'function') showAuthUI();
        });
    }

    // --- 4. Workflow (ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‹ã‚‰è¡¨ç¤ºã¾ã§ã®æ‰‹é †) ---

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã®æµã‚Œ
        async function startProfileWorkflow(decoded) {
            showStatus('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...');

            // npubã¾ãŸã¯nprofileã‹ã‚‰å…¬é–‹éµã‚’å–å¾—
            const pubkey = decoded.data.pubkey || decoded.data.id || decoded.data;

            // ãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆã®æ±ºå®šï¼ˆIDã«ç´ã¥ããƒªãƒ¬ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã°Fallbackï¼‰
            const relays = (decoded.data.relays && decoded.data.relays.length > 0)
                ? decoded.data.relays
                : FALLBACK_RELAYS;

            try {
                // 1. ãƒªãƒ¬ãƒ¼ã«æ¥ç¶š
                await relayManager.connect(relays[0]);

                // 2. è³¼èª­é–‹å§‹ (subId, filters, handler)
                // relay-manager.js ã®ä»•æ§˜é€šã‚Šã€3ã¤ã®å¼•æ•°ã‚’æ¸¡ã—ã¾ã™
                relayManager.subscribe(
                    'profile-query',           // subId
                    {                          // filters
                        kinds: [0],
                        authors: [pubkey],
                        limit: 1
                    },
                    (type, event) => {         // handler (ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                        if (type === 'EVENT' && event) {
                            try {
                                const profile = JSON.parse(event.content);
                                const npub = NostrTools.nip19.npubEncode(pubkey);

                                // 3. æç”»
                                const renderArea = document.getElementById('render-area');
                                renderArea.innerHTML = Components.profileCard(profile, npub);

                                showStatus(''); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¶ˆã™

                                // 4. ç”¨ãŒæ¸ˆã‚“ã ã‚‰è³¼èª­è§£é™¤
                                relayManager.unsubscribe('profile-query');
                            } catch (e) {
                                console.error("Profile parse error:", e);
                            }
                        }
                    }
                );

            } catch (err) {
                console.error("Connection error:", err);
                showStatus('ãƒªãƒ¬ãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

    // --- 1. ã¾ãšã‚¤ãƒ™ãƒ³ãƒˆã‚’1ã¤ã ã‘å–ã£ã¦ãã‚‹é–¢æ•° ---
    async function fetchSingleEvent(decoded) {
        const eventId = decoded.data.id || decoded.data;
        const relays = (decoded.data.relays && decoded.data.relays.length > 0) ? decoded.data.relays : FALLBACK_RELAYS;

        return new Promise(async (resolve) => {
            await relayManager.connect(relays[0]);

            const subId = `fetch-once-${eventId.substring(0, 8)}`;

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ5ç§’å¾…ã£ã¦ã‚‚æ¥ãªã‘ã‚Œã°nullï¼‰
            const timer = setTimeout(() => {
                relayManager.unsubscribe(subId);
                resolve(null);
            }, 5000);

            relayManager.subscribe(subId, { ids: [eventId], limit: 1 }, (type, event) => {
                if (type === 'EVENT' && event) {
                    clearTimeout(timer);
                    relayManager.unsubscribe(subId);
                    resolve(event);
                }
            });
        });
    }

    // --- 2. æŒ¯ã‚Šåˆ†ã‘ã‚’è¡Œã†ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ---
    async function startEventWorkflow(decoded) {
        showStatus('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');

        const event = await fetchSingleEvent(decoded);

        if (!event) {
            showStatus('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            const renderArea = document.getElementById('render-area');
            renderArea.innerHTML = Components.inputForm();
            setupFormListener();
            return;
        }

        // ã“ã“ã§ Kind ã”ã¨ã®å‡¦ç†ã«åˆ†å²ï¼
        console.log(`ğŸ“¡ Event Kind: ${event.kind} ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ`);

        switch (event.kind) {
            case 1:
            case 30023:
                // é€šå¸¸æŠ•ç¨¿ã€ã¾ãŸã¯ãƒ­ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ 
                await renderStandardPost(event);
                break;

            case 40:
            case 41:
                // ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ãã®ã‚‚ã®
                renderChannelMetadata(event);
                break;

            case 42:
                // ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆNIP-28ï¼‰
                await renderChannelMessage(event);
                break;

            case 6:
                // ãƒªãƒã‚¹ãƒˆï¼ˆå…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã«è¡Œããªã©ã®å‡¦ç†ãŒå¿…è¦ï¼‰
                renderGenericEvent(event, "ãƒªãƒã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ");
                break;

            default:
                // ãã®ä»–ï¼ˆæœªå®šç¾©ã®Kindï¼‰
                renderGenericEvent(event);
                break;
        }

        showStatus(''); // èª­ã¿è¾¼ã¿å®Œäº†
    }

    /**
     * Kind 40/41 (ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±) ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderChannelMetadata(event) {
        const renderArea = document.getElementById('render-area');
        let metadata;

        try {
            metadata = JSON.parse(event.content);
        } catch (e) {
            console.error("ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—", e);
            renderArea.innerHTML = `<p>ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ</p>`;
            return;
        }

        const name = metadata.name || 'ç„¡åãƒãƒ£ãƒ³ãƒãƒ«';
        const about = metadata.about || 'èª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“';
        const picture = metadata.picture || '';

        renderArea.innerHTML = `
        <div class="channel-card" style="border: 2px solid #5851db; border-radius: 12px; padding: 20px; background: #fdfdfd;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                ${picture ? `<img src="${picture}" style="width: 64px; height: 64px; border-radius: 8px; object-fit: cover;">` : `<div style="width: 64px; height: 64px; background: #eee; border-radius: 8px; display: grid; place-items: center;">ğŸ’¬</div>`}
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem;">${Components.utils.escape(name)}</h2>
                    <code style="font-size: 0.8rem; color: #888;">Kind 40 (Public Chat Channel)</code>
                </div>
            </div>
            <p style="white-space: pre-wrap; color: #444; line-height: 1.6;">${Components.utils.escape(about)}</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <button onclick="fetchChannelMessages('${event.id}')" style="background: #5851db; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                    ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
                </button>
            </div>
        </div>
    `;
    }

    /**
     * Kind 42 (ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    async function renderChannelMessage(event) {
        const renderArea = document.getElementById('render-area');
        const contentHtml = await Components.utils.formatContent(event.content, event.tags);

        // ã©ã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®æŠ•ç¨¿ã‹ã‚’æ¢ã™ï¼ˆeã‚¿ã‚°ã®rootï¼‰
        const channelTag = event.tags.find(t => t[0] === 'e');
        const channelId = channelTag ? channelTag[1] : null;

        renderArea.innerHTML = `
        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem;">
            ğŸ’¬ ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ <br>
            <small>Channel ID: <a href="?id=${channelId}">${channelId?.substring(0, 8)}...</a></small>
        </div>
        ${Components.eventBody(event, contentHtml, window.dataStore.getProfile(event.pubkey))}
    `;

        // æŠ•ç¨¿ã«ç´ã¥ããƒªãƒ—ãƒ©ã‚¤ç­‰ã‚’å–å¾—
        fetchRelatedData(event.id);
    }

    async function renderChannelMessage(event) {
        const renderArea = document.getElementById('render-area');
        const channelId = event.tags.find(t => t[0] === 'e' && (t[3] === 'root' || !t[3]))?.[1];

        // æœ¬æ–‡ã®æ•´å½¢
        const contentHtml = await Components.utils.formatContent(event.content, event.tags);
        const profile = window.dataStore.getProfile(event.pubkey);

        renderArea.innerHTML = `
        <div class="channel-context" style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
            ğŸ’¬ ãƒãƒ£ãƒ³ãƒãƒ«å†…ã®ç™ºè¨€: <a href="?id=${channelId}">${channelId?.substring(0, 8)}...</a>
        </div>
        ${Components.eventBody(event, contentHtml, profile)}
    `;

        // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆãƒªãƒ—ãƒ©ã‚¤ãªã©ï¼‰
        fetchRelatedData(event.id);
    }

    // --- é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒªãƒ—ãƒ©ã‚¤ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã®å–å¾— ---
    async function fetchRelatedData(eventId, relays) {
        const reactionsList = document.getElementById('reactions-list');
        const relatedList = document.getElementById('related-events-list');
        const subContent = document.getElementById('sub-content');

        // ãƒªãƒ—ãƒ©ã‚¤(1)ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³(7)ã‚’è³¼èª­
        relayManager.subscribe('related-data', { '#e': [eventId], kinds: [1, 7] }, async (type, event) => {
            if (type === 'EVENT' && event) {
                window.dataStore.addEvent(event);
                subContent.classList.remove('hidden');

                if (event.kind === 7) {
                    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°ï¼ˆDataStoreã®é›†è¨ˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ï¼‰
                    const counts = window.dataStore.getReactionCount(eventId);
                    reactionsList.innerHTML = Components.reactionSection({ length: counts.reactions });
                } else if (event.kind === 1) {
                    // ãƒªãƒ—ãƒ©ã‚¤ã®è¿½åŠ 
                    const html = await Components.utils.formatContent(event.content, event.tags);
                    relatedList.innerHTML += Components.replyCard(event, html);
                }
            }
        });
    }

    async function fetchQuotes() {
        const placeholders = document.querySelectorAll('.quote-placeholder');

        for (const el of placeholders) {
            const nip19Id = el.dataset.id;
            try {
                const decoded = NostrTools.nip19.decode(nip19Id);
                const targetId = decoded.data.id || decoded.data;
                const relays = (decoded.data.relays && decoded.data.relays.length > 0) ? decoded.data.relays : FALLBACK_RELAYS;

                // 1. ãƒªãƒ¬ãƒ¼ã«æ¥ç¶š
                await relayManager.connect(relays[0]);

                // 2. å¼•ç”¨ã‚¤ãƒ™ãƒ³ãƒˆæœ¬ä½“ã‚’è³¼èª­
                relayManager.subscribe(`quote-${targetId}`, { ids: [targetId], limit: 1 }, async (type, event) => {
                    if (type === 'EVENT' && event) {
                        // ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        const contentHtml = await Components.utils.formatContent(event.content, event.tags);

                        // --- è¿½åŠ ï¼šå¼•ç”¨å…ƒã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚‚å–å¾—ã™ã‚‹ ---
                        relayManager.subscribe(`profile-${event.pubkey}`, { kinds: [0], authors: [event.pubkey], limit: 1 }, (pType, pEvent) => {
                            if (pType === 'EVENT' && pEvent) {
                                const profileData = JSON.parse(pEvent.content);
                                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä»˜ãã§ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
                                el.innerHTML = Components.quoteCard(targetId, contentHtml, profileData);
                                relayManager.unsubscribe(`profile-${event.pubkey}`);
                            }
                        });

                        // ã¾ãšã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãªã—ã®çŠ¶æ…‹ã§è¡¨ç¤ºã—ã¦ãŠã
                        el.innerHTML = Components.quoteCard(targetId, contentHtml);
                        relayManager.unsubscribe(`quote-${targetId}`);
                    }
                });
            } catch (e) {
                console.error("å¼•ç”¨ã®å–å¾—ã«å¤±æ•—:", e);
            }
        }
    }

    // --- 5. å®Ÿè¡Œï¼ˆã“ã“ãŒã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰ ---
    document.addEventListener('DOMContentLoaded', () => {
        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setupEventListeners();

        // URLã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦æç”»ã‚’é–‹å§‹ã™ã‚‹
        initializeApp();
    });
</script>

</body>
</html>
